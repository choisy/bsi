---
title: "Blood stream infections"
csl: the-american-naturalist.csl
output:
  html_document:
    theme: cerulean
    toc: yes
  pdf_document:
    toc: yes
<!-- bibliography: references.bib -->
editor_options: 
  chunk_output_type: console
---

<!--
IMAGES:
Insert them with: ![alt text](image.png)
You can also resize them if needed: convert image.png -resize 50% image.png
If you want to center the image, go through HTML code:
<div style="text-align:center"><img src ="image.png"/></div>

REFERENCES:
For references: Put all the bibTeX references in the file "references.bib"
in the current folder and cite the references as @key or [@key] in the text.
Uncomment the bibliography field in the above header and put a "References"
title wherever you want to display the reference list.

<style type="text/css">
.main-container {
  max-width: 1370px;
  margin-left: auto;
  margin-right: auto;
}
</style>
-->

```{css horizontal scrolling, echo = FALSE}
pre, code {white-space:pre !important; overflow-x:scroll !important}

html { overflow-x: scroll; }
```


```{r general options, include = FALSE}
knitr::knit_hooks$set(
  margin = function(before, options, envir) {
    if (before) par(mgp = c(1.5, .5, 0), bty = "n", plt = c(.105, .97, .13, .97))
    else NULL
  },
  prompt = function(before, options, envir) {
    options(prompt = if (options$engine %in% c("sh", "bash")) "$ " else "> ")
  })

knitr::opts_chunk$set(cache = FALSE, autodep = TRUE, message = FALSE, warning = FALSE,
                      dev.args = list(pointsize = 11), fig.height = 3.5,
                      fig.width = 4.24725, fig.retina = 2, fig.align = "center")

#options(width = 137)
options(width = 200)
```

## Packages

Installing the required packages:

```{r}
required <- c("dplyr", "lubridate", "magrittr", "purrr", "readxl", "tibble", "tidyr")
to_install <- setdiff(required, row.names(installed.packages()))
if (length(to_install)) install.packages(to_install)
```

Loading `magrittr` for interactive use:

```{r}
library(magrittr)
```

## Accessory functions

The following function replaces `FALSE` surounded by `TRUE` values by `TRUE` in
a logical vector:

```{r}
fill_gaps <- function(x) {
  require(magrittr)
  as.integer(x) %>% # because easier to deal with 1-character encoding
    paste(collapse = "") %>% 
    gsub("101", "111", .)
}
```

Let's try it:

```{r}
fill_gaps(c(TRUE, FALSE, TRUE, TRUE, FALSE, FALSE, TRUE))
```

The following function replaces `111000111100110011` by `111000222200330044`

```{r}
episodes <- function(x) {
  require(magrittr)
  x %<>% 
    strsplit("") %>% 
    unlist() %>% 
    as.integer() %>% 
    rle()
  sel <- which(x$values > 0)
  x$values[sel] <- seq_along(sel)
  inverse.rle(x)
}
```

Let's try it:

```{r}
episodes("111000111100110011")
```

A tuning of the `dplyr::left_join()` function:

```{r}
leftjoin <- function(...) dplyr::left_join(..., by = "PatientNo")
```

A tuning of the `dplyr::bind_rows()` function:

```{r}
bindrows <- function(...) dplyr::bind_rows(..., .id = "PatientNo")
```

## Reading data

The data are in this file:

```{r}
data_file <- "19-8-2019-CTU16HN_Data.xls.xlsx"
```

The list of sheets that we are interested in:

```{r}
sheets <- c("ADM", "AIR", "APAC", "DAILY1n2", "ENR", "FINISH", "FU", "FU_DAY90", "MICBLD")
```

Reading all the sheets of this file and transforming the dates:

```{r warning = FALSE}
data <- sheets %>%
  lapply(readxl::read_excel, path = data_file) %>% 
  lapply(function(x) dplyr::mutate_if(x, function(y) "POSIXct" %in% class(y), as.Date)) %>% 
  setNames(sheets)
```

### Adding the episode variable to MICBLD

In order to be able to add the `episode` variable to `data$MICBLD` we need to
define the following function that computes the `episode` variable for a given
patient using the `fill_gaps()` and `episodes()` accessory functions that we
defined above:

```{r}
compute_episode <- function(x) {
  require(magrittr)
  x %$% 
    dplyr::full_join(data.frame(HAIDate = seq(min(HAIDate), max(HAIDate), 1), b = 1),
                     data.frame(HAIDate = sort(unique(HAIDate)), c = 2), "HAIDate") %>%
    assign("tmp1", ., 1) %>% 
    dplyr::mutate(d = !is.na(c)) %>% 
    purrr::pluck("d") %>% 
    fill_gaps() %>% 
    episodes() %>% 
    cbind(tmp1, episode = .) %>%
    dplyr::left_join(x, ., "HAIDate") %>% 
    dplyr::select(id, episode)
}
```

Adding the `episode` variable to `data$MICBLD`:

```{r}
data$MICBLD %<>% 
  dplyr::mutate(id = dplyr::row_number()) %>% 
  assign("tmp2", ., 1) %>% 
  dplyr::filter(OrganismsNo > 0) %>% 
  dplyr::select(id, PatientNo, HAIDate) %>% 
  split(.$PatientNo) %>% 
  lapply(compute_episode) %>% 
  dplyr::bind_rows() %>% 
  dplyr::left_join(tmp2, ., "id") %>% 
  dplyr::select(-id)
```

We can see that no patient has more than 2 BSI episodes:

```{r}
table(data$MICBLD$episode)
```

### Recoding some ADM variables into logical

```{r}
data$ADM %<>% 
  dplyr::mutate_at(
    c("Mode", "CongIV", "Seve", "AIDS", "Elective", "Emergency", "Myo", "DiaCo", "DiaDa"),
    function(x) dplyr::na_if(x, "NA") == "Yes")
```

### Exploring the data

Note that some of these data sets have one row per patient whereas other data
sets have more than one row per patient:

```{r}
(nbrow <- sapply(data, function(x) length(unique(table(x$PatientNo)))))
```

The number of rows of each of the data sets:

```{r}
sapply(data, nrow)
```

### Reading the dictionary of variables and levels

```{r}
dictionary <- readxl::read_excel("Copy of CTU16HN_DataDictionary.xlsx", "Category")
```

## Redefining MICBLD and DAILY1n2

The `MICBLD` and `DAILY1n2` data sets have several rows per patient. Here we
compute summaries of these data sets with one row per patient so that they can
easily be merge with the other data sets.

```{r}
(micbld <- lapply(list(function(x) x %>% # this function should be first
                         dplyr::group_by(PatientNo) %>% 
                         dplyr::summarise(bsi = any(OrganismsNo > 0)),
                       function(x) x %>% 
                         dplyr::filter(episode < 2) %>% # blood collection of first episode
                         dplyr::group_by(PatientNo) %>% 
                         dplyr::summarise(blood_collection = min(HAIDate))),
                  function(f) f(data$MICBLD)) %>% 
   purrr::reduce(leftjoin))
```

### The DAILY1n2 data set

The following function tells, for one data frame of one patient, where there are
two consecutive dates:

```{r}
two_consecutive <- function(x, name) {
  x %>% 
    dplyr::arrange(VSDate) %>% 
    purrr::pluck("VSDate") %>% 
    diff() %>% 
    `<`(2) %>% 
    any() %>% 
    tibble::enframe(name = NULL, value = name)
}
```

Let's try it:

```{r}
data$DAILY1n2 %>% 
  dplyr::filter(PatientNo == "003-001") %>% 
  dplyr::select(PatientNo, VSDate, CVCCount) %>% 
  print() %>% 
  two_consecutive("name")
```

List of functions:

```{r}
lfcts <- list(
  clbsi_risk = function(df, name) { # difference
    require(magrittr)
    df %>% 
      split(.$PatientNo) %>% 
      lapply(function(x) x %>% 
        dplyr::filter(CVCCount > 0) %>% # difference
        two_consecutive(name)) %>% 
      bindrows()
  },
  
  al_bsi_risk = function(df, name) { # difference
    require(magrittr)
    df %>% 
      split(.$PatientNo) %>% 
      lapply(function(x) x %>% 
        dplyr::filter(Arterial == "Yes") %>% # difference
        two_consecutive(name)) %>% 
      bindrows()
  },
  
  clbsi = function(df, name) { # difference
    require(magrittr)
    df %>% 
      leftjoin(micbld) %>% 
      split(.$PatientNo) %>% 
      lapply(function(x) x %>% 
               dplyr::filter(CVCCount > 0) %>% # difference
               dplyr::filter(blood_collection - VSDate < 6) %>% 
               two_consecutive(name)) %>% 
      bindrows()
  },
  
  al_bsi = function(df, name) { # difference
    require(magrittr)
    df %>% 
      leftjoin(micbld) %>% 
      split(.$PatientNo) %>% 
      lapply(function(x) x %>% 
               dplyr::filter(Arterial == "Yes") %>% # difference
               dplyr::filter(blood_collection - VSDate < 6) %>% 
               two_consecutive(name)) %>% 
      bindrows()
  },
  
  had_catheter = function(df, name) {
    require(magrittr)
    df %>% 
      group_by(PatientNo) %>% 
      summarise(catheter = any(CVCCount > 0)) %>% 
      dplyr::mutate(catheter = tidyr::replace_na(catheter, FALSE))
  },
  
  nb_cl_days = function(df, name) {
    require(magrittr)
    df %>% 
      split(.$PatientNo) %>% 
      lapply(function(x) x %>% 
               dplyr::filter(CVCCount > 0) %>% 
               nrow() %>% 
               tibble::enframe(name = NULL, value = "nb_cl_days")) %>% 
      bindrows()
  },
  
  nb_days_before_bsi = function(df, name) {
    require(magrittr)
    df %>% 
      leftjoin(micbld) %>%
      group_by(PatientNo) %>% 
      summarise(nb_days_before_bsi = sum(VSDate < blood_collection))
    }
    
  )
```

Applying to `data$DAILY1n2`:

```{r}
(daily <- purrr::map2(lfcts, names(lfcts), function(f, x) f(data$DAILY1n2, x)) %>% 
  purrr::reduce(leftjoin))
```

## Defining populations / groups

The code below defines the variables of interest.

```{r safe, eval = FALSE, include = FALSE}
data2 <- data$FINISH %>%
  dplyr::select(PatientNo, IsCompleted, IsAgree, HosDate, ICUDate) %>% 
  leftjoin(dplyr::select(data$ENR, PatientNo, Age, RandDate, YOB, Sex)) %>%
  leftjoin(dplyr::select(data$ADM, PatientNo, Source, NKQ, HospitalDate, Mode, CongIV, Seve, AIDS, Elective, Emergency,
                         Tetanus, Pneumonia, Sepsis, Septic, CNS, COPD, CVA, Myo, SpOther, DiaCo, DiaDa)) %>%
  leftjoin(dplyr::select(data$AIR, PatientNo, IsTrach)) %>%
  
# exclude patients not completed and not agreed --------------------------------
  dplyr::filter(!(IsCompleted == 2 & IsAgree != "Yes")) %>% 
  
# define BSI variable ----------------------------------------------------------
  dplyr::left_join(dplyr::filter(data$MICBLD, OrganismsNo > 0) %>% 
                     purrr::pluck("PatientNo") %>% 
                     unique() %>% 
                     tibble::tibble(PatientNo = ., bsi = TRUE), "PatientNo") %>% 
  dplyr::mutate(bsi = tidyr::replace_na(bsi, FALSE)) %>%  # replace NA with FALSE
  
# define patients at risk of CLBSI ---------------------------------------------
  dplyr::left_join(dplyr::filter(data$DAILY1n2, CVCCount > 0) %>% # similar to AL BSI
                     dplyr::group_by(PatientNo) %>%  # same as for AL BSI
                     dplyr::summarise(clbsi_risk = any(diff(VSDate) < 2)), "PatientNo") %>% # similar to AL BSI
  dplyr::mutate(clbsi_risk = tidyr::replace_na(clbsi_risk, FALSE)) %>%  # replace NA with FALSE, similar to AL BSI
  
# define CLBSI -----------------------------------------------------------------
  dplyr::left_join(dplyr::filter(data$DAILY1n2, CVCCount > 0) %>% # similar to AL BSI
                     dplyr::left_join(micbld, "PatientNo") %>% # same as for AL BSI
                     dplyr::filter(blood_collection - VSDate < 6) %>%  # same as for AL BSI
                     dplyr::group_by(PatientNo) %>%                    # same as for AL BSI
                     dplyr::summarise(clbsi = any(diff(VSDate) < 2)), "PatientNo") %>% # similar to AL BSI
  dplyr::mutate(clbsi = tidyr::replace_na(clbsi, FALSE)) %>%  # replace NA with FALSE, similar to AL BSI
  
# define patients at risk of arterial line BSI ---------------------------------
  dplyr::left_join(dplyr::filter(data$DAILY1n2, Arterial == "Yes") %>% # similar to CLBSI
                     dplyr::group_by(PatientNo) %>% # same as for CLBSI
                     dplyr::summarise(al_bsi_risk = any(diff(VSDate) < 2)), "PatientNo") %>% # similar to CLBSI
  dplyr::mutate(al_bsi_risk = tidyr::replace_na(al_bsi_risk, FALSE)) %>%  # replace NA with FALSE, similar to CLBSI
  
# define patients with arterial line BSI ---------------------------------------
  dplyr::left_join(dplyr::filter(data$DAILY1n2, Arterial == "Yes") %>% # similar to CLBSI
                     dplyr::left_join(micbld, "PatientNo") %>% # same as for CLBSI
                     dplyr::filter(blood_collection - VSDate < 6) %>%  # same as for CLBSI
                     dplyr::group_by(PatientNo) %>%                    # same as for CLBSI
                     dplyr::summarise(al_bsi = any(diff(VSDate) < 2)), "PatientNo") %>% # similar to CLBSI
  dplyr::mutate(al_bsi = tidyr::replace_na(al_bsi, FALSE),  # replace NA with FALSE, similar to CLBSI
    
# define HABSI variable --------------------------------------------------------
    habsi = tidyr::replace_na(HosDate - HospitalDate > 1, FALSE), # replace NA with FALSE
    
# define hospitals -------------------------------------------------------------
    hospital = dplyr::recode(sub("-.*$", "", PatientNo),
                             `003` = "HTD",
                             `020` = "NHTD",
                             `103` = "BVTV"),

# any tracheostomy -------------------------------------------------------------
    tracheo  = NKQ < 2 | dplyr::na_if(IsTrach, "NA") == "Yes",

# define tracheostomy vs month -------------------------------------------------
    nkq      = c("tracheostomy", "mouth")[NKQ],

# computing age ----------------------------------------------------------------
    age      = ifelse(is.na(Age), round(as.numeric(RandDate - lubridate::ymd(paste(YOB, "0101"))) / 365), Age),  # maybe we should consider 1st of July instead?
  
# other pathogens:
    otherpth = ! is.na(SpOther), 

# durations:
    rand2icu   = ICUDate - RandDate,
    rand2hos   = HosDate - RandDate,
    adm2icu    = ICUDate - HospitalDate,
    adm2hos    = HosDate - HospitalDate,

# patient-days: 
    patdayRand = sum(ICUDate - RandDate),
    patdayHosp = sum(HosDate - RandDate),

# at least one catheter:
    
  
# sepsis:
    sepsis   = Sepsis | Septic) %>% 
  
# selecting variables of interest ----------------------------------------------
  dplyr::select(-IsCompleted, -IsAgree, -HosDate, -Age, -YOB, -SpOther, -IsTrach, -NKQ, -Sepsis, -Septic, -ICUDate)
```

```{r}
data2 <- data$FINISH %>%
  dplyr::select(PatientNo, IsCompleted, IsAgree, HosDate, ICUDate) %>% 
  leftjoin(dplyr::select(data$ENR, PatientNo, Age, RandDate, YOB, Sex)) %>%
  leftjoin(dplyr::select(data$ADM, PatientNo, Source, NKQ, HospitalDate, Mode, CongIV, Seve, AIDS, Elective, Emergency,
                         Tetanus, Pneumonia, Sepsis, Septic, CNS, COPD, CVA, Myo, SpOther, DiaCo, DiaDa)) %>%
  leftjoin(dplyr::select(data$AIR, PatientNo, IsTrach)) %>%
  leftjoin(dplyr::select(micbld, -blood_collection)) %>% 
  leftjoin(daily) %>% 
  
# exclude patients not completed and not agreed --------------------------------
  dplyr::filter(!(IsCompleted == 2 & IsAgree != "Yes")) %>% 

# replace NA with FALSE --------------------------------------------------------  
  dplyr::mutate_at(c("bsi", "clbsi_risk", "clbsi", "al_bsi_risk", "al_bsi"), tidyr::replace_na, FALSE) %>% 

  dplyr::mutate(
# define HABSI variable --------------------------------------------------------
    habsi = tidyr::replace_na(HosDate - HospitalDate > 1, FALSE), # replace NA with FALSE
    
# define hospitals -------------------------------------------------------------
    hospital = dplyr::recode(sub("-.*$", "", PatientNo),
                             `003` = "HTD",
                             `020` = "NHTD",
                             `103` = "BVTV"),

# any tracheostomy -------------------------------------------------------------
    tracheo = NKQ < 2 | dplyr::na_if(IsTrach, "NA") == "Yes",

# define tracheostomy vs month -------------------------------------------------
    nkq = c("tracheostomy", "mouth")[NKQ],

# computing age ----------------------------------------------------------------
    age = ifelse(is.na(Age), round(as.numeric(RandDate - lubridate::ymd(paste(YOB, "0101"))) / 365), Age),  # maybe we should consider 1st of July instead?
  
# other pathogens:
    otherpth = ! is.na(SpOther), 

# durations:
    rand2icu = ICUDate - RandDate,
    rand2hos = HosDate - RandDate,
    adm2icu  = ICUDate - HospitalDate,
    adm2hos  = HosDate - HospitalDate,

# patient-days: 
    patdayRand = sum(ICUDate - RandDate),
    patdayHosp = sum(HosDate - RandDate),

# row 3, page 5:
    nb_cl_days = ifelse(bsi, nb_days_before_bsi, nb_cl_days),
  
# sepsis:
    sepsis = Sepsis | Septic) %>% 
  
# selecting variables of interest ----------------------------------------------
  dplyr::select(-IsCompleted, -IsAgree, -HosDate, -Age, -YOB, -SpOther, -IsTrach, -NKQ, -Sepsis, -Septic, -ICUDate, -nb_days_before_bsi)
```

**Note:** nothing to worry about the parsing failure. It concerns `NA` in the
`YOB` variable that is not used anyway.

## APACHE-II Scores

The Apache-II Score provides an estimate of ICU mortality based on a number of
laboratory values and patient signs taking both acute and chronic disease into
account.

**Note:** The data used should relate to the 24 hours prior to randomisation and
the worst (highest scoring) recorded values should be used.

This function below computes score functions:

```{r}
make_score_functions <- function(scores, values) {
  function(x) scores[cut(x, c(-Inf, values, +Inf), right = FALSE)]
}
```

The parameters values for the score functions:

```{r}
apache_physio <- list(
  temp = list(
    scores = c(4:0, 1, 3, 4),
    values = c(30, 32, 34, 36, 38.5, 39, 41)),
  bp = list(
    scores = c(4, 2, 0, 2:4),
    values = c(50, 70, 110, 130, 160)),
  hr = list(
    scores = c(4, 3, 2, 0, 2, 3, 4),
    values = c(40, 55, 70, 110, 140, 180)),
  rr = list(
    scores = c(4, 2, 1, 0, 1, 3, 4),
    values = c(6, 10, 25, 35, 50)),
  pao2 = list(
    scores = 4:0,
    values = c(55, 61, 70)),
  aa_gradient = list(
    scores = 0:4,
    values = c(200, 350, 500)),
  ph = list(
    scores = c(4, 3, 2, 0, 1, 3, 4),
    values = c(7.15, 7.25, 7.33, 7.5, 7.6, 7.7)),
  hco3 = list(
    scores = c(4, 3, 2, 0, 1, 3, 4),
    values = c(15, 18, 23, 32, 41, 52)),
  na = list(
    scores = c(4:2, 0:4),
    values = c(111, 120, 130, 150, 155, 160, 180)),
  k = list(
    scores = c(4, 2:0, 1, 3, 4),
    values = c(2.5, 3, 3.5, 5.5, 6, 7)),
  creatinine = list(
    scores = c(2, 0, 2:4),
    values = c(0.6, 1.5, 2, 3.5)),
  hematocrit = list(
    scores = c(4, 2, 0:2, 4),
    values = c(20, 30, 46, 50, 60)),
  wbc = list(
    scores = c(4, 2, 0:2, 4),
    values = c(1, 3, 15, 20, 40)),
  age = list(
    scores = c(0, 2, 3, 5, 6),
    values = c(45, 55, 65, 75)))
```

Let's generate the score functions:

```{r}
score_fcts <- setNames(lapply(apache_physio,
                              function(x) make_score_functions(x$scores, x$values)), 
                       names(apache_physio))
```

Let's see an example:

```{r}
head(score_fcts$temp(data$DAILY1n2$TempMax), 100)
```

```{r}
data$APAC %>% 
  dplyr::left_join(dplyr::select(data2, PatientNo, age, RandDate, Mode, CongIV, Seve, AIDS, Elective, Emergency), "PatientNo") %>% 
  dplyr::left_join(dplyr::select(data$DAILY1n2, PatientNo, VSDate, TempMax, TempMin), c("PatientNo", "RandDate" = "VSDate")) %>% 
  dplyr::mutate(a = score_fcts$temp(TempMax),
                b = score_fcts$temp(TempMin),
                temp_score = ifelse(a < b, b, a),
                map_score  = score_fcts$bp((2 * Diastolic + Systolic) / 3),
                a = score_fcts$hr(PuHightest),
                b = score_fcts$hr(PuLowest),
                hr_score = ifelse(a < b, b, a),
                a = score_fcts$rr(ResHightest),
                b = score_fcts$rr(ResLowest),
                rr_score = ifelse(a < b, b, a),
                PaCO2 = ifelse(is.na(PaCO2), HCO3 / (0.03 * 10 ^ (ArterialpH - 6.1)), PaCO2),
                aa_gradient = 713 * FiO2 - PaCO2 / .8 - PaO2,
                a_score = ifelse(is.na(aa_gradient) | FiO2 < .5, score_fcts$pao2(PaO2), score_fcts$aa_gradient(aa_gradient)),
                ph_score = ifelse(is.na(ArterialpH), score_fcts$hco3(HCO3), score_fcts$ph(ArterialpH)),
                na_score = score_fcts$na(Sodium),
                k_score = score_fcts$k(Potassium),
                creatinine_score = score_fcts$creatinine(Creatinine),
                hematocrit_score = score_fcts$hematocrit(Haematocrit),
                wbc_score = score_fcts$wbc(BloodCell),
                gcs_score = 15 - ifelse(GlasgowScore == "Preintubation",
                                        ifelse(is.na(Motor) | is.na(Verbal) | is.na(Eyes) |
                                                 Motor == 0 | Verbal == 0   | Eyes == 0   |
                                                 Motor == 9 | Verbal == 9   | Eyes == 9,
                                               Total,
                                               Motor + Verbal + Eyes),
                                        15),
                age_score = score_fcts$age(age),
                c_score = ifelse(Mode + CongIV + Seve + AIDS < 1,
                                 0,
                                 ifelse(Emergency,
                                        5,
                                        ifelse(Elective, 2, 5))),
                apache = temp_score + map_score + hr_score + rr_score + a_score + ph_score + na_score + k_score +
                         creatinine_score + hematocrit_score + wbc_score + gcs_score + age_score + c_score) %>% 
  dplyr::select(PatientNo, TempMin, TempMax, temp_score, map_score, hr_score, rr_score, a_score, ph_score, na_score, k_score,
                creatinine_score, hematocrit_score, wbc_score, gcs_score, age_score, c_score, apache) %>% 
  dplyr::filter(is.na(apache)) %>% 
  print(n = 23)
```

As we can see above, some scores are `NA`. We need to think about how to deal
with that.

## Table 1: demographics

```{r}
f1 <- function(v, g, data) {
  require(magrittr)
  data %>% 
    dplyr::mutate(x = ! .[[v]],
                  y = .[[g]]) %>%
    dplyr::group_by(y, x) %>% 
    dplyr::tally() %>% 
    dplyr::ungroup() %>% 
    dplyr::mutate(x = dplyr::recode(as.character(x), `FALSE` = paste("with", toupper(v)), `TRUE` = paste("without", toupper(v)))) %>% 
    tidyr::pivot_wider(names_from = x, values_from = n)
}
```

```{r}
f2 <- function(v, g, data) {
  require(magrittr)
  iqr <- function(x) {
    tmp <- quantile(x, c(.25, .5, .75), na.rm = TRUE)
    paste0(tmp[2], " (IQR: ", tmp[1], "-", tmp[3], ")")
  }
  data2 %>% 
    dplyr::mutate(x = ! .[[v]],
                  y = .[[g]]) %>%
    dplyr::group_by(x) %>% 
    dplyr::summarize(y = iqr(y)) %>% 
    dplyr::mutate(x = dplyr::recode(as.character(x), `FALSE` = paste("with", toupper(v)), `TRUE` = paste("without", toupper(v)))) %>% 
    tidyr::pivot_wider(names_from = x, values_from = y)
}
```

Some recoding of variables:

```{r}
recoding <- function(df, var) {
  for (i in var)
    df[, i] <- dplyr::recode(as.character(unlist(df[, i])), `TRUE` = i, `FALSE` = paste("no", i))
  df
}
```

```{r}
data3 <- recoding(data2, c("tracheo", "clbsi_risk", "al_bsi_risk", "Tetanus", "Pneumonia", "sepsis",
                           "CNS", "COPD", "CVA", "Myo", "otherpth", "Mode", "catheter"))
```

```{r}
for(v in c("habsi", "bsi", "clbsi", "al_bsi")) {
  for (g in c("hospital", "Sex", "Source", "nkq", "tracheo", "clbsi_risk", "al_bsi_risk", "Tetanus",
              "Pneumonia", "sepsis", "CNS", "COPD", "CVA", "Myo", "otherpth", "Mode", "catheter"))
    print(f1(v, g, data3))
}
```

```{r}
f1("habsi", "Tetanus", data3)
```

```{r}
f2("habsi", "age", data2)
```

```{r}
for(v in c("habsi", "bsi", "clbsi", "al_bsi")) {
  c("age", "rand2icu", "rand2hos", "adm2icu", "adm2hos", "patdayRand", "patdayHosp", "nb_cl_days") %>% 
    setNames(purrr::map(., f2, v = v, data = data2), .) %>% 
    dplyr::bind_rows(.id = "variable") %>% 
    print()
}
```

