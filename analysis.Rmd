---
title: "Blood stream infections"
csl: the-american-naturalist.csl
output:
  html_document:
    theme: cerulean
    toc: yes
  pdf_document:
    toc: yes
<!-- bibliography: references.bib -->
editor_options: 
  chunk_output_type: console
---

<!--
IMAGES:
Insert them with: ![alt text](image.png)
You can also resize them if needed: convert image.png -resize 50% image.png
If you want to center the image, go through HTML code:
<div style="text-align:center"><img src ="image.png"/></div>

REFERENCES:
For references: Put all the bibTeX references in the file "references.bib"
in the current folder and cite the references as @key or [@key] in the text.
Uncomment the bibliography field in the above header and put a "References"
title wherever you want to display the reference list.

<style type="text/css">
.main-container {
  max-width: 1370px;
  margin-left: auto;
  margin-right: auto;
}
</style>
-->

```{css horizontal scrolling, echo = FALSE}
pre, code {white-space:pre !important; overflow-x:scroll !important}

html { overflow-x: scroll; }
```


```{r general options, include = FALSE}
knitr::knit_hooks$set(
  margin = function(before, options, envir) {
    if (before) par(mgp = c(1.5, .5, 0), bty = "n", plt = c(.105, .97, .13, .97))
    else NULL
  },
  prompt = function(before, options, envir) {
    options(prompt = if (options$engine %in% c("sh", "bash")) "$ " else "> ")
  })

knitr::opts_chunk$set(cache = FALSE, autodep = TRUE, message = FALSE, warning = FALSE,
                      dev.args = list(pointsize = 11), fig.height = 3.5,
                      fig.width = 4.24725, fig.retina = 2, fig.align = "center")

options(width = 137)
```

## Packages

Installing the required packages:

```{r}
required <- c("dplyr", "lubridate", "magrittr", "purrr", "readxl", "tibble", "tidyr")
to_install <- setdiff(required, row.names(installed.packages()))
if (length(to_install)) install.packages(to_install)
```

Loading `magrittr` for interactive use:

```{r}
library(magrittr)
```

## Reading data

The data are in this file:

```{r}
data_file <- "19-8-2019-CTU16HN_Data.xls.xlsx"
```

The list of sheets that we are interested in:

```{r}
sheets <- c("ADM", "AIR", "APAC", "DAILY1n2", "ENR", "FINISH", "FU", "FU_DAY90", "MICBLD")
```

Reading all the sheets of this file:

```{r warning = FALSE}
data <- sheets %>%
  lapply(readxl::read_excel, path = data_file) %>% 
  setNames(sheets)
```

Note that some of these data sets have one row per patient whereas other data
sets have more than one row per patient:

```{r}
(nbrow <- sapply(data, function(x) length(unique(table(x$PatientNo)))))
```

```{r}
sapply(data, nrow)
```

Reading the dictionary of variables and levels:

```{r}
dictionary <- readxl::read_excel("Copy of CTU16HN_DataDictionary.xlsx", "Category")
```

## Accessory functions

```{r}
fill_gaps <- function(x) {
  require(magrittr)
  as.integer(x) %>%         # because easier to deal with 1-character encoding
    paste(collapse = "") %>% 
    gsub("101", "111", .)
}
```

```{r}
episodes <- function(x) {
  require(magrittr)
  x %<>% 
    strsplit("") %>% 
    unlist() %>% 
    as.integer() %>% 
    rle()
  sel <- which(x$values > 0)
  x$values[sel] <- seq_along(sel)
  inverse.rle(x)
}
```

This function uses `fill_gaps()` and `episodes()` to compute the `episode`
variable for a given patient:

```{r}
compute_episode <- function(x) {
  require(magrittr)
  x %$% 
    dplyr::full_join(data.frame(HAIDate = seq(min(HAIDate), max(HAIDate), 1), b = 1),
                     data.frame(HAIDate = sort(unique(HAIDate)), c = 2), "HAIDate") %>%
    assign("tmp1", ., 1) %>% 
    dplyr::mutate(d = !is.na(c)) %>% 
    purrr::pluck("d") %>% 
    fill_gaps() %>% 
    episodes() %>% 
    cbind(tmp1, episode = .) %>%
    dplyr::left_join(x, ., "HAIDate") %>% 
    dplyr::select(id, episode)
}
```

## Defining populations / groups

Adding the `episode` variable to `data$MICBLD`:

```{r}
data$MICBLD %<>% 
  dplyr::mutate(id      = dplyr::row_number(),
                HAIDate = as.Date(HAIDate)) %>% 
  assign("tmp2", ., 1) %>% 
  dplyr::filter(OrganismsNo > 0) %>% 
  dplyr::select(id, PatientNo, HAIDate) %>% 
  split(.$PatientNo) %>% 
  lapply(compute_episode) %>% 
  dplyr::bind_rows() %>% 
  dplyr::left_join(tmp2, ., "id") %>% 
  dplyr::select(-id)
```

We can see that no patient has more than 2 BSI episodes:

```{r}
table(data$MICBLD$episode)
```

Defining blood collection date of first episode:

```{r}
first_episodes <- data$MICBLD %>% 
  dplyr::filter(episode < 2) %>%
  dplyr::group_by(PatientNo) %>% 
  dplyr::summarise(blood_collection = min(HAIDate))
```

Converting the `VSDate` variable of `data$DAILY1n2`:

```{r}
data$DAILY1n2 %<>% dplyr::mutate(VSDate = as.Date(VSDate))
```

Defining variables:

```{r}
data2 <- data$FINISH %>%
  
# exclude patients not completed and not agreed --------------------------------
  dplyr::filter(!(IsCompleted == 2 & IsAgree != "Yes")) %>% 
  
# define HABSI variable --------------------------------------------------------
  dplyr::left_join(dplyr::select(data$ADM, PatientNo, HospitalDate), "PatientNo") %>%
  dplyr::mutate(habsi = tidyr::replace_na(HosDate - HospitalDate > 1, FALSE)) %>% # replace NA with FALSE
  
# define BSI variable ----------------------------------------------------------
  dplyr::left_join(dplyr::filter(data$MICBLD, OrganismsNo > 0) %>% 
                     purrr::pluck("PatientNo") %>% 
                     unique() %>% 
                     tibble::tibble(PatientNo = ., bsi = TRUE), "PatientNo") %>% 
  dplyr::mutate(bsi = tidyr::replace_na(bsi, FALSE)) %>%  # replace NA with FALSE
  
# define patients at risk of CLBSI ---------------------------------------------
  dplyr::left_join(dplyr::filter(data$DAILY1n2, CVCCount > 0) %>% 
                     dplyr::group_by(PatientNo) %>% 
                     dplyr::summarise(clbsi_risk = any(diff(VSDate) < 2)), "PatientNo") %>% 
  dplyr::mutate(clbsi_risk = tidyr::replace_na(clbsi_risk, FALSE)) %>%  # replace NA with FALSE
  
# define CLBSI -----------------------------------------------------------------
  dplyr::left_join(dplyr::filter(data$DAILY1n2, CVCCount > 0) %>% 
                     dplyr::left_join(first_episodes, "PatientNo") %>% # same as for AL BSI
                     dplyr::filter(blood_collection - VSDate < 6) %>%  # same as for AL BSI
                     dplyr::group_by(PatientNo) %>%                    # same as for AL BSI
                     dplyr::summarise(clbsi = any(diff(VSDate) < 2)), "PatientNo") %>% 
  dplyr::mutate(clbsi = tidyr::replace_na(clbsi, FALSE)) %>%  # replace NA with FALSE
  
# define patients at risk of arterial line BSI ---------------------------------
  dplyr::left_join(dplyr::filter(data$DAILY1n2, Arterial == "Yes") %>% 
                     dplyr::group_by(PatientNo) %>% 
                     dplyr::summarise(al_bsi_risk = any(diff(VSDate) < 2)), "PatientNo") %>% 
  dplyr::mutate(al_bsi_risk = tidyr::replace_na(al_bsi_risk, FALSE)) %>%  # replace NA with FALSE
  
# define patients with arterial line BSI ---------------------------------------
  dplyr::left_join(dplyr::filter(data$DAILY1n2, Arterial == "Yes") %>% 
                     dplyr::left_join(first_episodes, "PatientNo") %>% # same as for CLBSI
                     dplyr::filter(blood_collection - VSDate < 6) %>%  # same as for CLBSI
                     dplyr::group_by(PatientNo) %>%                    # same as for CLBSI
                     dplyr::summarise(al_bsi = any(diff(VSDate) < 2)), "PatientNo") %>% 
  dplyr::mutate(al_bsi = tidyr::replace_na(al_bsi, FALSE)) %>%  # replace NA with FALSE

# adding other variables -------------------------------------------------------
  dplyr::left_join(dplyr::select(data$ENR, PatientNo, Age, RandDate, YOB, Sex), "PatientNo") %>%
  dplyr::left_join(dplyr::select(data$ADM, PatientNo, Source, NKQ), "PatientNo") %>%
  dplyr::left_join(dplyr::select(data$AIR, PatientNo, IsTrach), "PatientNo") %>%

  dplyr::mutate(
# define hospitals -------------------------------------------------------------
    hospital = dplyr::recode(sub("-.*$", "", PatientNo),
                             `003` = "HTD",
                             `020` = "NHTD",
                             `103` = "BVTV"),

# any tracheostomy -------------------------------------------------------------
#    tracheo  = ifelse(NKQ < 2 | IsTrach == "Yes", "tracheostomy", "no tracheostomy"),
    tracheo  = NKQ < 2 | IsTrach == "Yes",

# define tracheostomy vs month -------------------------------------------------
    nkq      = c("tracheostomy", "mouth")[NKQ],

# computing age ----------------------------------------------------------------
    age      = ifelse(is.na(Age), round(as.numeric(as.Date(RandDate) - lubridate::ymd(paste(YOB, "0101"))) / 365), Age)) # maybe we should consider 1st of July instead?
```

## Table 1: demographics

```{r}
f1 <- function(v, g, data) {
  require(magrittr)
  data %>% 
    dplyr::mutate(x = ! .[[v]],
                  y = .[[g]]) %>%
    dplyr::group_by(y, x) %>% 
    dplyr::tally() %>% 
    dplyr::ungroup() %>% 
    dplyr::mutate(x = dplyr::recode(as.character(x), `FALSE` = paste("with", toupper(v)), `TRUE` = paste("without", toupper(v)))) %>% 
    tidyr::pivot_wider(names_from = x, values_from = n)
}
```

```{r}
f2 <- function(v, g, data) {
  require(magrittr)
  iqr <- function(x) {
    tmp <- quantile(x, c(.25, .5, .75))
    paste0(tmp[2], " (IQR: ", tmp[1], "-", tmp[3], ")")
  }
  data2 %>% 
    dplyr::mutate(x = .[[v]],
                  y = .[[g]]) %>%
    dplyr::group_by(x) %>% 
    dplyr::summarize(y = iqr(y)) %>% 
    dplyr::mutate(x = dplyr::recode(as.character(x), `FALSE` = paste("with", toupper(v)), `TRUE` = paste("without", toupper(v)))) %>% 
    tidyr::pivot_wider(names_from = x, values_from = y)
}
```

```{r}
data3 <- data2 %>% 
  dplyr::mutate(tracheo     = dplyr::recode(as.character(tracheo),
                                            `TRUE`  = "tracheostomy",
                                            `FALSE` = "no tracheostomy"),
                clbsi_risk  = recode(as.character(clbsi_risk),
                                     `TRUE` = "CV cath",
                                     `FALSE` = "no CV cath"),
                al_bsi_risk = recode(as.character(al_bsi_risk),
                                    `TRUE` = "art cath",
                                    `FALSE` = "no art cath"))
```

```{r}
for(v in c("habsi", "bsi", "clbsi_risk", "clbsi", "al_bsi_risk", "al_bsi")) {
  for (g in c("hospital", "Sex", "Source", "nkq", "tracheo", "clbsi_risk", "al_bsi_risk")) print(f1(v, g, data3))
}
```

```{r}
f1("habsi", "al_bsi_risk", data3)
```

```{r}
f2("habsi", "age", data2)
```

## APACHE-II Scoe

The Apache-II Score provides an estimate of ICU mortality based on a number of
laboratory values and patient signs taking both acute and chronic disease into
account.

**Note:** The data used should relate to the 24 hours prior to randomisation and
the worst (highest scoring) recorded values should be used.

This function below computes score functions:

```{r}
make_score_functions <- function(scores, values) {
  function(x) scores[cut(x, c(-Inf, values, +Inf), right = FALSE)]
}
```

The parameters values for the score functions:

```{r}
apache_physio <- list(
  temp = list(
    scores = c(4:0, 1, 3, 4),
    values = c(30, 32, 34, 36, 38.5, 39, 41)),
  bp = list(
    scores = c(4, 2, 0, 2:4),
    values = c(50, 70, 110, 130, 160)),
  hr = list(
    scores = c(4, 3, 2, 0, 2, 3, 4),
    values = c(40, 55, 70, 110, 140, 180)),
  rr = list(
    scores = c(4, 2, 1, 0, 1, 3, 4),
    values = c(6, 10, 25, 35, 50)),
  pao2 = list(
    scores = 4:0,
    values = c(55, 61, 70)),
  aa_gradient = list(
    scores = 0:4,
    values = c(200, 350, 500)),
  ph = list(
    scores = c(4, 3, 2, 0, 1, 3, 4),
    values = c(7.15, 7.25, 7.33, 7.5, 7.6, 7.7)),
  hco3 = list(
    scores = c(4, 3, 2, 0, 1, 3, 4),
    values = c(15, 18, 23, 32, 41, 52)),
  na = list(
    scores = c(4:2, 0:4),
    values = c(111, 120, 130, 150, 155, 160, 180)),
  k = list(
    scores = c(4, 2:0, 1, 3, 4),
    values = c(2.5, 3, 3.5, 5.5, 6, 7)),
  creatinine = list(
    scores = c(2, 0, 2:4),
    values = c(0.6, 1.5, 2, 3.5)),
  hematocrit = list(
    scores = c(4, 2, 0:2, 4),
    values = c(20, 30, 46, 50, 60)),
  wbc = list(
    scores = c(4, 2, 0:2, 4),
    values = c(1, 3, 15, 20, 40)),
  age = list(
    scores = c(0, 2, 3, 5, 6),
    values = c(45, 55, 65, 75)))
```

Let's generate the score functions:

```{r}
score_fcts <- setNames(lapply(apache_physio,
                              function(x) make_score_functions(x$scores, x$values)), 
                       names(apache_physio))
```

Let's add the last score function:

```{r}
score_fcts$gcs <- function(x) {
  15 - x
}
```

Let's see an example:

```{r}
score_fcts$temp(data$DAILY1n2$TempMax)
```

```{r}
data$ADM %<>% 
  mutate(Mode      = Mode      == "Yes",
         CongIV    = CongIV    == "Yes",
         Seve      = Seve      == "Yes",
         AIDS      = AIDS      == "Yes",
         Elective  = Elective  == "Yes",
         Emergency = Emergency == "Yes")
```

```{r}
data$ENR %<>% dplyr::mutate(RandDate = as.Date(RandDate))
```


```{r}
data$APAC %>% 
  dplyr::left_join(dplyr::select(data2, PatientNo, age), "PatientNo") %>% 
  dplyr::left_join(dplyr::select(data$ENR, PatientNo, RandDate), "PatientNo") %>% 
  dplyr::left_join(dplyr::select(data$ADM, PatientNo, Mode, CongIV, Seve, AIDS, Elective, Emergency), "PatientNo") %>% 
  dplyr::left_join(dplyr::select(data$DAILY1n2, PatientNo, VSDate, TempMax, TempMin), c("PatientNo", "RandDate" = "VSDate")) %>% 
  dplyr::mutate(a = score_fcts$temp(TempMax),
                b = score_fcts$temp(TempMin),
                temp_score = ifelse(a < b, b, a),
                map_score  = score_fcts$bp((2 * Diastolic + Systolic) / 3),
                a = score_fcts$hr(PuHightest),
                b = score_fcts$hr(PuLowest),
                hr_score = ifelse(a < b, b, a),
                a = score_fcts$rr(ResHightest),
                b = score_fcts$rr(ResLowest),
                rr_score = ifelse(a < b, b, a),
                PaCO2 = ifelse(is.na(PaCO2), HCO3 / (0.03 * 10 ^ (ArterialpH - 6.1)), PaCO2),
                aa_gradient = 713 * FiO2 - PaCO2 / .8 - PaO2,
                a_score = ifelse(is.na(aa_gradient) | FiO2 < .5, score_fcts$pao2(PaO2), score_fcts$aa_gradient(aa_gradient)),
                ph_score = ifelse(is.na(ArterialpH), score_fcts$hco3(HCO3), score_fcts$ph(ArterialpH)),
                na_score = score_fcts$na(Sodium),
                k_score = score_fcts$k(Potassium),
                creatinine_score = score_fcts$creatinine(Creatinine),
                hematocrit_score = score_fcts$hematocrit(Haematocrit),
                wbc_score = score_fcts$wbc(BloodCell),
                gcs = ifelse(GlasgowScore == "Preintubation",
                             ifelse(is.na(Motor) | is.na(Verbal) | is.na(Eyes) |
                                      Motor == 0 | Verbal == 0   | Eyes == 0   |
                                      Motor == 9 | Verbal == 9   | Eyes == 9,
                                    Total,
                                    Motor + Verbal + Eyes),
                             15),
                gcs_score = score_fcts$gcs(gcs),
                age_score = score_fcts$age(age),
                c_score = ifelse(Mode + CongIV + Seve + AIDS < 1,
                                 0,
                                 ifelse(Emergency,
                                        5,
                                        ifelse(Elective, 2, 5))),
                apache = temp_score + map_score + hr_score + rr_score + a_score + ph_score + na_score + k_score +
                         creatinine_score + hematocrit_score + wbc_score + gcs_score + age_score + c_score) %>% 
  select(PatientNo, TempMin, TempMax, temp_score, map_score, hr_score, rr_score, a_score, ph_score, na_score, k_score,
         creatinine_score, hematocrit_score, wbc_score, gcs_score, age_score, c_score, apache) %>% 
  filter(is.na(apache)) %>% 
  print(n = 23)
```



