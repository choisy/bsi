---
title: "Another shot"
csl: the-american-naturalist.csl
output:
  html_document:
    theme: cerulean
    toc: yes
  pdf_document:
    toc: yes
<!-- bibliography: references.bib -->
editor_options: 
  chunk_output_type: console
---

<!--
IMAGES:
Insert them with: ![alt text](image.png)
You can also resize them if needed: convert image.png -resize 50% image.png
If you want to center the image, go through HTML code:
<div style="text-align:center"><img src ="image.png"/></div>

REFERENCES:
For references: Put all the bibTeX references in the file "references.bib"
in the current folder and cite the references as @key or [@key] in the text.
Uncomment the bibliography field in the above header and put a "References"
title wherever you want to display the reference list.
-->

<style type="text/css">
.main-container {
  max-width: 1370px;
  margin-left: auto;
  margin-right: auto;
}
</style>

```{r general options, include = FALSE}
knitr::knit_hooks$set(
  margin = function(before, options, envir) {
    if (before) par(mgp = c(1.5, .5, 0), bty = "n", plt = c(.105, .97, .13, .97))
    else NULL
  },
  prompt = function(before, options, envir) {
    options(prompt = if (options$engine %in% c("sh", "bash")) "$ " else "> ")
  })

knitr::opts_chunk$set(margin = TRUE, #prompt = TRUE, comment = "", collapse = TRUE,
                      cache = FALSE, autodep = TRUE,
                      dev.args = list(pointsize = 11), fig.height = 3.5,
                      fig.width = 4.24725, fig.retina = 2, fig.align = "center")

options(width = 260)
```

## 0. Packages

Installing the required packages from CRAN:

```{r}
required <- c("car", "dplyr", "lubridate", "magrittr", "purrr", "readxl",
              "stringr", "survival", "tibble", "tidyr", "writexl")
installed <- row.names(installed.packages())
to_install <- setdiff(required, installed)
if (length(to_install)) install.packages(to_install)
```

Plus `C306` from GitHub:

```{r}
if (! "C306" %in% installed) {
  if (! "remotes" %in% installed) install.packages("remotes")
  remotes::install_github("lampk/C306")
}
```

Loading packages for interactive use:

```{r, message = FALSE}
library(magrittr)
library(dplyr)
library(purrr)
library(tidyr)
library(lubridate)
library(tibble)
library(stringr)
library(C306)
library(survival)
#library(huxtable)
```

### Utilitary functions

Theh following functions converts a "Yes/No" variable into a boolean variable,
dealing with missing values properly:

```{r}
yesno2bool <- function(x) {
  na_if(x, "NA") == "Yes"
}
```

## 1. Reading and putting the data in shape

### Reading data
The data are in this file:

```{r}
data_file <- "19-8-2019-CTU16HN_Data.xls.xlsx"
```

The sheets that we are interested in are the following ones:

```{r}
sheets <- c("ADM", "AIR", "APAC", "DAILY1n2", "ENR", "FINISH", "FU", "FU_DAY90", "MICBLD")
```

Reading all the sheets of this file and transforming the dates:

```{r warning = FALSE}
data <- sheets %>%
  lapply(readxl::read_excel, path = data_file) %>% 
  lapply(function(x) dplyr::mutate_if(x, function(y) "POSIXct" %in% class(y), as.Date)) %>% 
  setNames(sheets)
```

```{r include = FALSE, eval = FALSE}
sheets <- readxl::excel_sheets("19-8-2019-CTU16HN_Data.xls.xlsx")
data_all <- sheets %>%
  lapply(readxl::read_excel, path = data_file) %>% 
  lapply(function(x) dplyr::mutate_if(x, function(y) "POSIXct" %in% class(y), as.Date)) %>% 
  setNames(sheets)
```

#### Tyding data

The data about discharge:

```{r}
data$FINISH %<>% 
  select(PatientNo, IsCompleted, IsAgree, HosDate, ICUDate, OutCome, HosSame) %>%
  rename(ICUDateFINISH = ICUDate) %>% 
  distinct()
```

Where:

`IsComplete == 1`: completed until discharge or death

`IsAgree == "Yes"`: agree to use data for those who didn't complete.

`HosDate`: date of discharge

`ICUDate`: date of this study ward discharge

`OutCome`: death or not

The data about admission:

```{r}
data$ADM %<>% 
  select(PatientNo, HospitalDate, NKQ, Tetanus, Pneumonia, Sepsis, Septic, CNS,
         COPD, CVA, Myo, SpOther, DiaCo, DiaDa, Mode, CongI_III, Peri, Cere, Deme,
         Chro, Conn, Peptic, Hemi, ModeSeve, Meta, AIDS, AnyMa, CongIV, Elective,
         Emergency, Source, Mild, Seve, ICUDate) %>%
  rename(ICUDateADM = ICUDate) %>% 
  distinct()
```

The following function corrects the names of the bacteria:

```{r}
correct_names <- function(x) {
  x %>% 
    str_to_sentence() %>% 
    str_replace("Staph epidermidis"                 , "Staphylococcus epidermidis") %>%
    str_replace("Staph haemolyticus"                , "Staphylococcus haemolyticus") %>%
    str_replace("S.marcescens"                      , "Serratia marcescens") %>% 
    str_replace("Elizabethkingie"                   , "Elizabethkingia") %>% 
    str_replace("Enterobacter aerogenes"            , "Klebsiella aerogenes") %>% 
    str_replace("Proteus mirasilis"                 , "Proteus mirabilis") %>% 
    str_replace("Staphylococcin epidermidis"        , "Staphylococcus epidermidis") %>% 
    str_replace("Staphylococcs xylosus"             , "Staphylococcus xylosus") %>% 
    str_replace("Stenotrophomonas malto"            , "Stenotrophomonas maltophilia") %>% 
    str_replace("Enterococcus fecalis"              , "Enterococcus faecalis") %>% 
    str_replace("Stenotrophomonas maltophiliaphilia", "Stenotrophomonas maltophilia") %>% 
    str_replace(" \\(-\\)", "")
}
```

Blood microbiology:

```{r}
data$MICBLD %<>% 
  select(PatientNo, HAIDate, OrganismsNo, Iden1, Iden2, OtherIden1, OtherIden2,
         IsOxac1, IsESBL1, IsColistin1, IsOxac2, IsESBL2, IsColistin2) %>% 
  mutate_at(vars(IsOxac1, IsESBL1, IsColistin1, IsOxac2, IsESBL2, IsColistin2), yesno2bool) %>%
  mutate_at(vars(OtherIden1, OtherIden2), correct_names) %>% 
  mutate_at(vars(Iden1, Iden2), recode, `1` = "Pseudomonas aeruginosa",
                                        `2` = "Klebsiella pneumoniae",
                                        `3` = "Staphylococcus aureus",
                                        `4` = "Acinetobacter baumanii",
                                        `5` = "Escherichia coli",
                                        `6` = "otherpath") %>% 
  mutate(Iden1 = ifelse(Iden1 == "otherpath", OtherIden1, Iden1),
         Iden2 = ifelse(Iden2 == "otherpath", OtherIden2, Iden2),
         condition = Iden1 < Iden2,
         Iden1b = ifelse(condition, Iden1, Iden2),
         Iden2b = ifelse(condition, Iden2, Iden1)) %>% 
  unite("pathogens", Iden1b, Iden2b, sep = ", ") %>% 
  mutate(pathogens = ifelse(pathogens == "NA, NA", Iden1, pathogens)) %>% 
  select(-OtherIden1, -OtherIden2, -condition) %>% 
  distinct()
```

`HAIDate`: date of sampling

Daily monitoring:

```{r}
data$DAILY1n2 %<>% 
  select(PatientNo, CVCCount, VSDate, Arterial, TempMax, TempMin) %>% 
  mutate_at(vars(Arterial), yesno2bool) %>% 
  distinct()
```

`CVCCount`: number of central venous catheters.

Patient information:

```{r}
data$ENR %<>%
  select(PatientNo, Sex, Age, YOB, RandDate) %>% 
  distinct()
```

Ventilation:

```{r}
data$AIR %<>% 
  select(PatientNo, IsTrach, TrachDate) %>% 
  distinct()
```

Apache code variables:

```{r}
data$APAC %<>% 
  select(PatientNo, HbA1c, Sodium, Potassium, Creatinine, Haematocrit, BloodCell,
         Systolic, Diastolic, PuHightest, PuLowest, ResHightest, ResLowest, FiO2,
         PaO2, PaCO2, HCO3, ArterialpH, GlasgowScore, Motor, Verbal, Eyes, Total) %>% 
  distinct()
```

Follow-up at 28 days:

```{r}
data$FU %<>%
  select(PatientNo, DeathDate28, Status28, Date28) %>% # We probably don't need this any more for now
  distinct()
```

Follow-up at 90 days:

```{r}
data$FU_DAY90 %<>%
  select(PatientNo, DeathDate90, Status90, Date90) %>% # We probably don't need this any more for now
  distinct()
```

### Microbiology variables (MICBLD)

#### Adding episode variable

The following function adds the episode variable:

```{r}
add_episode <- function(x) {
# it's not clear why the filter() / right_join() doesn't work here and has to be
# after the group_modify() call below.
  x %>% 
#    filter(OrganismsNo > 0) %>% 
    add_column(episode = cumsum(c(1, ! (diff(.$HAIDate) < 2 | (diff(.$HAIDate) < 3 & diff(as.integer(as.factor(.$pathogens))) < 1)))))# %>% 
#    right_join(select(x, PatientNo, HAIDate))
}
```

Let's try it:

```{r}
data$MICBLD %>% 
  filter(OrganismsNo > 0) %>% 
  arrange(HAIDate) %>% 
  filter(PatientNo == "020-526") %>% 
  add_episode()
```

Let's add it to the whole data set:

```{r}
data$MICBLD %<>% 
  filter(OrganismsNo > 0) %>% 
  arrange(HAIDate) %>% 
  group_by(PatientNo) %>% 
  group_modify(~ add_episode(.x)) %>% 
  ungroup() %>% 
  right_join(select(data$MICBLD, PatientNo, HAIDate), c("PatientNo", "HAIDate"))
```

#### Other variables

Patients with BSI, showing the date of the first BSI episode:

```{r}
first_bsi <- data$MICBLD %>% 
  filter(OrganismsNo > 0) %>% 
  arrange(HAIDate) %>% 
  group_by(PatientNo) %>% 
  summarise(first_BSI = first(HAIDate))
```

Numbers of BSI episodes:

```{r}
nb_bsi <- data$MICBLD %>% 
  filter(OrganismsNo > 0) %>% 
  group_by(PatientNo) %>% 
  summarise(nb_bsi = length(unique(episode)))
```

Number of pathogens in the first episode of BSI:

```{r}
nb_path_bsi1 <- data$MICBLD %>% 
  filter(episode < 2) %>% 
  group_by(PatientNo) %>% 
  summarise(nb_path_bsi1 = length(unique(first(strsplit(paste(unlist(pathogens), collapse = ", "), ", ")))))
```

### Daily monitoring variables (DAILY1n2)

Patients with catheter:

```{r}
had_catheter <- data$DAILY1n2 %>% 
  group_by(PatientNo) %>% 
  summarise(had_catheter = any(CVCCount > 0))
```

Patients with arterial line during ICU stay:

```{r}
had_arterial <- data$DAILY1n2 %>% 
  group_by(PatientNo) %>% 
  summarise(had_arterial = any(Arterial))
```

Patients at risk of CLBSI (i.e. with central line placement for at least 2
consecutive days):

```{r}
clbsi_risk <- data$DAILY1n2 %>% 
  filter(CVCCount > 0) %>% 
  group_by(PatientNo) %>% 
  summarise(CLBSI_risk = ifelse(length(VSDate) > 1, any(diff(VSDate) < 2), FALSE))
```

Patients with CLBSI

```{r}
clbsi <- left_join(first_bsi, data$DAILY1n2, "PatientNo") %>% 
  filter(first_BSI - VSDate < 6, CVCCount > 0) %>% 
  group_by(PatientNo) %>% 
  summarise(CLBSI = ifelse(length(VSDate) > 1, any(diff(VSDate) < 2), FALSE))
```

Patients at risk of ALBSI:

```{r}
albsi_risk <- data$DAILY1n2 %>% 
  filter(Arterial) %>% 
  group_by(PatientNo) %>% 
  summarise(ALBSI_risk = ifelse(length(VSDate) > 1, any(diff(VSDate) < 2), FALSE))
```

Patients with ALBSI:

```{r}
albsi <- left_join(first_bsi, data$DAILY1n2, "PatientNo") %>% 
  filter(first_BSI - VSDate < 6, Arterial) %>% 
  group_by(PatientNo) %>% 
  summarise(ALBSI = ifelse(length(VSDate) > 1, any(diff(VSDate) < 2), FALSE))
```

Total number of Central line days:

```{r}
nb_cl_days <- left_join(data$DAILY1n2, first_bsi, "PatientNo") %>% 
  filter(is.na(first_BSI) | VSDate < first_BSI, CVCCount > 0) %>% 
  group_by(PatientNo) %>% 
  tally() %>%
  rename(nb_cl_days = n)
```

Total number of arterial line days:

```{r}
nb_al_days <- left_join(data$DAILY1n2, first_bsi, "PatientNo") %>% 
  filter(is.na(first_BSI) | VSDate < first_BSI, Arterial) %>% 
  group_by(PatientNo) %>% 
  tally() %>% 
  rename(nb_al_days = n)
```

### Other variables

Need to be calculated now because the calculation of APACHE-II need the age
variable that is calculated here.

```{r}
data2 <- c(data[setdiff(names(data), c("DAILY1n2", "MICBLD"))],
           list(first_bsi, clbsi_risk, clbsi, albsi_risk, albsi, nb_cl_days,
                nb_al_days, nb_bsi, nb_path_bsi1, had_catheter, had_arterial)) %>% 
  reduce(left_join, by = "PatientNo") %>% 
  mutate_at(c("CLBSI_risk", "CLBSI", "ALBSI_risk", "ALBSI", "had_catheter", "had_arterial"),
            replace_na, FALSE) %>% 
  mutate_at(c("nb_cl_days", "nb_al_days", "nb_bsi"), replace_na, 0) %>% 
  mutate_at(vars(IsAgree, Myo, DiaCo, DiaDa, Mode, CongI_III, Peri, Cere, Deme,
                 Chro, Conn, Peptic, Hemi, ModeSeve, Meta, AIDS, AnyMa, CongIV,
                 Elective, Emergency, Mild, Seve, IsTrach), yesno2bool) %>% 
  mutate(
# at risk of hopital acquired blood stream infection:
         habsi_risk   = replace_na(HosDate - HospitalDate > 1, FALSE),
# hospitals:
         hospital     = recode(sub("-.*$", "", PatientNo),
                                 `003` = "HTD",
                                 `020` = "NHTD",
                                 `103` = "BVTV"),
# ages:
         age          = ifelse(is.na(Age),
                               round(as.numeric(RandDate - ymd(paste(YOB, "0101"))) / 365),
                               Age),
# HABSI:
         habsi        = nb_bsi > 0,
# recode NKQ:
         NKQ          = recode(NKQ, `1` = "tracheostomy", `2` = "mouth"),
# tracheostomy:
         tracheostomy = NKQ == "mouth" | IsTrach,
         tracheostomy = ifelse(habsi, tracheostomy & TrachDate < first_BSI, tracheostomy),
# sepsis:
         sepsis = Sepsis | Septic,
# comorbidity of diabetes:
         dia_co       = DiaCo | DiaDa | HbA1c >= 6.5,
# durations:
         rand2icu     = ICUDateFINISH - RandDate,
         rand2hos     = HosDate - RandDate,
         adm2icu      = ICUDateFINISH - HospitalDate,
         adm2hos      = HosDate - HospitalDate,
         ICUstay      = ICUDateFINISH - ICUDateADM,
# time of BSI potential event:
         time2bsi     = ifelse(is.na(first_BSI), ICUDateFINISH, first_BSI) - as.numeric(RandDate),
# death at hospital discharge:
#         deathHOSdis  = OutCome < 3,
# death at ICU discharge:
#         deathICUdis  = deathHOSdis & HosDate == ICUDateFINISH,
# death 28 days:
#         death28days  = Status28 == "Died",
# death 90 days:
#         death90days  = Status90 == "Died",
# other pathogen:
         otherpath    = ! is.na(SpOther),
# transfer from other hospital:
         otherhosp    = Source == "Other hospital")
```

Nothing to worry about the 8 failed to parse.

### Adding Charlson scores

Computing and adding the Charlson scores to `data2`:

```{r}
charlson <- data2 %>% 
  select(PatientNo, Myo, CongI_III, Peri, Cere, Deme, Chro, Conn, Peptic,
         Mild, DiaCo, Hemi, ModeSeve, DiaDa, AnyMa, Mode, Meta, AIDS) %>% 
  mutate_all(replace_na, FALSE) %>% 
  mutate_if(is.logical, as.integer) %>% 
  mutate_at(vars(Hemi, ModeSeve, DiaDa, AnyMa), function(x) 2 * x) %>% 
  mutate_at(vars(Meta, AIDS), function(x) 6 * x) %>% 
  mutate(Mode         = 3 * Mode) %>% 
  mutate(charlson     = select_if(., is.numeric) %>% rowSums())
```

Let's compare with Thinh:

```{r}
charlson_trinh <- readRDS("charlson_score.rds")

setdiff(charlson$PatientNo, charlson_trinh$PatientNo)
setdiff(charlson_trinh$PatientNo, charlson$PatientNo)

marc <- charlson %>% 
  arrange(PatientNo) %>% 
  select(-PatientNo) %>%
  mutate_all(as.integer)

trinh <- charlson_trinh %>% 
  arrange(PatientNo) %>% 
  select(-PatientNo) %>% 
  mutate_all(as.integer)

any(! unlist(map2(marc, trinh, identical)))
```

```{r}
charlson2 <- charlson %>% 
  mutate_at(vars(charlson), ~ cut(.x, c(-Inf, 0, 2, 4, Inf)) %>% as.character()) %>% 
  select(PatientNo, charlson)
```

Let's add to `data2`:

```{r}
data2 %<>% left_join(charlson2, "PatientNo")
```

### Adding APACHE-II scores

The Apache-II Score provides an estimate of ICU mortality based on a number of
laboratory values and patient signs taking both acute and chronic disease into
account.

**Note:** The data used should relate to the 24 hours prior to randomisation and
the worst (highest scoring) recorded values should be used.

This function below computes score functions:

```{r}
make_score_functions <- function(scores, values) {
  function(x) scores[cut(x, c(-Inf, values, +Inf), right = FALSE)]
}
```

The parameters values for the score functions:

```{r}
apache_physio <- list(
  temp = list(
    scores = c(4:0, 1, 3, 4),
    values = c(30, 32, 34, 36, 38.5, 39, 41)),
  bp = list(
    scores = c(4, 2, 0, 2:4),
    values = c(50, 70, 110, 130, 160)),
  hr = list(
    scores = c(4, 3, 2, 0, 2, 3, 4),
    values = c(40, 55, 70, 110, 140, 180)),
  rr = list(
    scores = c(4, 2, 1, 0, 1, 3, 4),
    values = c(6, 10, 12, 25, 35, 50)),
  pao2 = list(
    scores = c(4, 3, 1, 0),
    values = c(55, 61, 70)),
  aa_gradient = list(
    scores = c(0, 2:4),
    values = c(200, 350, 500)),
  ph = list(
    scores = c(4, 3, 2, 0, 1, 3, 4),
    values = c(7.15, 7.25, 7.33, 7.5, 7.6, 7.7)),
  hco3 = list(
    scores = c(4, 3, 2, 0, 1, 3, 4),
    values = c(15, 18, 23, 32, 41, 52)),
  na = list(
    scores = c(4:2, 0:4),
    values = c(111, 120, 130, 150, 155, 160, 180)),
  k = list(
    scores = c(4, 2:0, 1, 3, 4),
    values = c(2.5, 3, 3.5, 5.5, 6, 7)),
  creatinine = list(
    scores = c(2, 0, 2:4),
    values = c(0.6, 1.5, 2, 3.5)),
  hematocrit = list(
    scores = c(4, 2, 0:2, 4),
    values = c(20, 30, 46, 50, 60)),
  wbc = list(
    scores = c(4, 2, 0:2, 4),
    values = c(1, 3, 15, 20, 40)),
  age = list(
    scores = rev(c(0, 2, 3, 5, 6)),
    values = c(44, 54, 64, 74)))
```

Let's generate the score functions:

```{r}
score_fcts <- setNames(lapply(apache_physio,
                              function(x) make_score_functions(x$scores, x$values)), 
                       names(apache_physio))
```

Let's see an example:

```{r}
head(score_fcts$temp(data$DAILY1n2$TempMax), 100)
```

Computing and adding the apache scores to `data2`:

```{r}
apache <- data$APAC %>% 
  left_join(select(data2, PatientNo, age, RandDate, Mode, CongIV, Seve, AIDS, Elective, Emergency), "PatientNo") %>% 
  left_join(select(data$DAILY1n2, PatientNo, VSDate, TempMax, TempMin), c("PatientNo", "RandDate" = "VSDate")) %>% 
  mutate(a = score_fcts$temp(TempMax),
         b = score_fcts$temp(TempMin),
         temp_score = ifelse(a < b, b, a),
         map_score  = score_fcts$bp((2 * Diastolic + Systolic) / 3),
         a = score_fcts$hr(PuHightest),
         b = score_fcts$hr(PuLowest),
         hr_score = ifelse(a < b, b, a),
         a = score_fcts$rr(ResHightest),
         b = score_fcts$rr(ResLowest),
         rr_score = ifelse(a < b, b, a),
         
         PaCO2 = ifelse(is.na(PaCO2), HCO3 / (0.03 * 10 ^ (ArterialpH - 6.1)), PaCO2),
         aa_gradient = 713 * FiO2 - PaCO2 / .8 - PaO2,
#         a_score = ifelse(is.na(aa_gradient) | FiO2 < .5, score_fcts$pao2(PaO2), score_fcts$aa_gradient(aa_gradient)),
         a_score = ifelse(is.na(FiO2) | FiO2 < .5, score_fcts$pao2(PaO2), score_fcts$aa_gradient(aa_gradient)),
         
         ph_score = ifelse(is.na(ArterialpH), score_fcts$hco3(HCO3), score_fcts$ph(ArterialpH)),
         
         na_score = score_fcts$na(Sodium),
         k_score = score_fcts$k(Potassium),
         creatinine_score = score_fcts$creatinine(Creatinine),
         hematocrit_score = score_fcts$hematocrit(Haematocrit),
         wbc_score = score_fcts$wbc(BloodCell),
         gcs_score = ifelse(is.na(GlasgowScore),
                            NA,
                            15 - ifelse(GlasgowScore == "Preintubation",
                                        ifelse(is.na(Motor) | is.na(Verbal) | is.na(Eyes) |
                                                 Motor == 0 | Verbal == 0   | Eyes == 0   |
                                                 Motor == 9 | Verbal == 9   | Eyes == 9,
                                               Total,
                                               Motor + Verbal + Eyes),
                                        15)),
#         gcs_score = 15 - ifelse(GlasgowScore == "Preintubation",
#                                 ifelse(is.na(Motor) | is.na(Verbal) | is.na(Eyes) |
#                                          Motor == 0 | Verbal == 0   | Eyes == 0   |
#                                          Motor == 9 | Verbal == 9   | Eyes == 9,
#                                        Total,
#                                        Motor + Verbal + Eyes),
#                                 15),
         age_score = score_fcts$age(age),
         c_score = ifelse(Mode + CongIV + Seve + AIDS < 1,
                          0,
                          ifelse(Emergency,
                                 5,
                                 ifelse(Elective, 2, 5)))) %>% 
  select(PatientNo, TempMin, TempMax, temp_score, map_score, hr_score, rr_score, a_score, ph_score, na_score, k_score,
         creatinine_score, hematocrit_score, wbc_score, gcs_score, age_score, c_score) %>% 
  mutate_all(replace_na, 0) %>% 
  mutate(apache = temp_score + map_score + hr_score + rr_score + a_score + ph_score + na_score + k_score +
                     creatinine_score + hematocrit_score + wbc_score + gcs_score + age_score + c_score) %>% 
  select(-TempMin, -TempMax)
```

Let's compare with Trinh:

```{r}
apache_trinh <- readRDS("apache.ii_score.rds") %>% 
  mutate_if(is.factor, as.character)

setdiff(apache$PatientNo, apache_trinh$PatientNo)
setdiff(apache_trinh$PatientNo, apache$PatientNo)

marc <- apache %>% 
  arrange(PatientNo) %>% 
  select(-PatientNo, -apache, -a_score, -ph_score)

trinh <- apache_trinh %>% 
  arrange(PatientNo) %>% 
  select(-PatientNo, -aapo2, -pao2, -ph, -hco3, -total_score)

trinh[] <- lapply(trinh, function(x) {x[which(is.infinite(x))] <- 0; x})

#any(! unlist(map2(marc, trinh, identical)))
unlist(map2(marc, trinh, identical))
```

```{r}
data2 %<>% left_join(select(apache_trinh, PatientNo, total_score) %>% rename(apache = total_score), "PatientNo")
```

### Adding mortalities from Trinh

```{r}
data2 <- readRDS("death_day.full.rds") %>% 
  mutate(death28 = Event > 0  & DOD < 29,
         death90 = Event > 0  & DOD < 91) %>%
  select(PatientNo, death28, death90, DOD) %>% 
  left_join(select(readRDS("icu_mortality.full.rds"), -IsTetanus), "PatientNo") %>% 
  rename(deathICU = IsDeath) %>% 
  left_join(data2, ., "PatientNo") %>% 
  mutate(VARI = as.character(VARI) == "VARI")
```

Note that there are 6 missing values in `DOD`. Adding `VAT` and `VAP` from Trinh
too.

```{r}
data2 <- readRDS("protocol.VARI.rds") %>% 
  select(PatientNo, VAP, VAT) %>% 
  left_join(data2, ., "PatientNo") %>% 
  mutate_at(vars(VAP, VAT), replace_na, FALSE)
```

Note here that Trinh's data have 521 observations only. Missing values were
replaced by `FALSE`.

### Filtering the data set

Non-eligible patients:

```{r}
non_eligible_IDs <- c("020-007", "020-012", "020-063", "003-089", "003-053", "003-110")
```

```{r}
data2 %<>% filter(! (IsCompleted > 1 & ! IsAgree),
                  ! PatientNo %in% non_eligible_IDs)
```

### Cleaning the data set

```{r}
data2 %<>% 
  select(PatientNo, hospital, Sex, age, otherhosp, NKQ, tracheostomy,
         CLBSI_risk, ALBSI_risk, apache, charlson, Tetanus, Pneumonia, sepsis,
         CNS, COPD, CVA, Myo, otherpath, dia_co, Mode, rand2icu, rand2hos, adm2icu,
         adm2hos, time2bsi, had_catheter, nb_cl_days, had_arterial, nb_al_days, habsi,
         habsi_risk, CLBSI_risk, CLBSI, ALBSI_risk, ALBSI, DOD, death28, death90, deathICU,
         VARI, nb_bsi, nb_path_bsi1, VAT, VAP) %>% 
  mutate_if(is.numeric, as.integer)
```

Saving to disk:

```{r}
write.csv(data2, "bsi.csv", quote = FALSE, row.names = FALSE)
```

and 

```{r}
writexl::write_xlsx(data2, "bsi.xlsx")
```

The data set `data2` used used for all the analyses below in available in CSV 
[here](https://raw.githubusercontent.com/choisy/bsi/master/bsi.csv) and in
excel [here](https://raw.githubusercontent.com/choisy/bsi/master/bsi.csv).

## 2. Derivation of Table 1 on demographics

### Utilitary functions

```{r}
groups <- c("habsi_risk", "habsi", "CLBSI_risk", "CLBSI", "ALBSI_risk", "ALBSI", "Tetanus", "death at ICU discharge", "death at hospital discharge")
```

```{r}
remove_boolean <- function(x) {
  sel <- which(x[, 1] == "- TRUE")
  x[sel - 2, c(3, 5, 7)] <- x[sel, c(3, 5, 7)]
  x[-c(sel - 1, sel), ]
}
```

```{r}
add_cause_admission <- function(x, causes) {
  sel <- which(x[, 1] == causes[1])
  nb <- x[sel, ]
  nb[1] <- "Causes of admission"
  nb[c(3, 5, 7)] <- ""
  x[which(x[, 1] %in% causes), 2] <- ""
  x <- rbind(x[1:(sel - 1), ], nb, x[sel:nrow(x), ])
  for(i in causes) x[, 1] <- sub(i, paste("-", i), x[, 1])
  x
}
```

```{r}
patient_day <- function(g, v, df) {
  df %>% 
    group_by({{ g }}) %>% 
    summarise(pd = sum({{ v }}, na.rm = TRUE)) %>% 
    pivot_wider(names_from = 1, values_from = pd) %>% 
    unlist() %>% 
    rev(.) %>% 
    c(sum(.)) %>% 
    `[<-`(c("patient-day", rep("", 6)), c(2, 4, 6), .)
}
```

```{r}
mean_ci <- function(x) {
  m <- lm(x ~ 1)
  paste0(round(coef(m), 2), " (", paste(round(confint(m), 2), collapse = ", "), ")")
}
```

Let's try it:

```{r}
mean_ci(data2$nb_cl_days)
```

```{r}
day_per_patient <- function(g, v, data) {
  data %>% 
    group_by({{ g }}) %>% 
    summarise(a = mean_ci({{ v }})) %>%
    pivot_wider(names_from = 1, values_from = a) %>% 
    unlist() %>% 
    rev(.) %>% 
    c(mean_ci(unlist(select(data, {{ v }})))) %>% 
    `[<-`(c("day/patient", rep("", 6)), c(3, 5, 7), .) %>% 
    `[<-`(c(2, 4, 6), group_by(data, {{ g }}) %>%
                        tally() %>%
                        pull() %>%
                        rev() %>% 
                        c(nrow(data)))
}
```

```{r, include = FALSE, eval = FALSE}
ht_theme_markdown <- function(ht, header_rows = 1, header_cols = 1,
                              border_width = .8, border_color = grey(.75),
                              strip = TRUE) {
  top_border(ht)[1, ] <- border_width
  bottom_border(ht)[nrow(ht), ] <- border_width
  for (header_row in header_rows) bold(ht)[header_row, ] <- TRUE
  bottom_border(ht)[max(header_rows), ] <- border_width
  for (header_col in header_cols) bold(ht)[header_col, ] <- TRUE
  ht <- set_all_border_colors(ht, border_color)
  if(strip) ht <- map_background_color(ht, by_rows(grey(.95), "white"))
  ht
}
```

The following function generate Table 1 for a given group `x`:

```{r}
make_table_1 <- function(x) {
  new_x <- paste0(x, 2)
  data2[["new_x"]] <- ifelse(data2[[x]], x, paste0("non-", x))
  data2 %>% 
    mutate_at(c("rand2icu", "rand2hos", "adm2icu", "adm2hos"), as.integer) %>% 
    sstable.baseline(hospital + Sex + age + otherhosp + NKQ + tracheostomy +
                       CLBSI_risk + ALBSI_risk + apache + charlson + Tetanus +
                       Pneumonia + sepsis + CNS + COPD + CVA + Myo + otherpath +
                       dia_co + Mode + rand2icu + rand2hos + adm2icu + adm2hos +
                       had_catheter + nb_cl_days + had_arterial + nb_al_days +
                       habsi + deathICU + death28 + death90 ~ new_x,
                     data = ., pooledGroup = TRUE, digits = 1, flextable = FALSE) %>% 
    `$`("table") %>%
    as.data.frame(stringsAsFactors = FALSE) %>%
    remove_boolean() %>%
    add_cause_admission(c("Tetanus", "Pneumonia", "sepsis", "CNS", "COPD", "CVA", "Myo", "otherpath")) %>%
    assign("tmp", ., 1) %>%
    tail(., nrow(.) - 2) %>%
    mutate(V1 = sub("-", "-   -", V1)) %>%
    `colnames<-`(tmp[2, ]) %>%
    as.matrix %>%
    rbind(reduce(list(patient_day(new_x, rand2icu, data2),
                      patient_day(new_x, rand2hos, data2),
                      patient_day(new_x, nb_cl_days, data2),
                      patient_day(new_x, nb_al_days, data2),
                      day_per_patient(new_x, nb_cl_days, data2),
                      day_per_patient(new_x, nb_al_days, data2)), rbind) %>%
            as_tibble() %>% # to be able to use mutate()
            mutate(V1 = c("rand2icu pd", "rand2hos pd", "nb_cl pd", "nb_al pd", "nb_cl pp", "nb_al pp")) %>%
            as.matrix()) %>% # to be able to use rbind() (because column names do not match)
    as.data.frame(stringsAsFactors = FALSE)
}
```

### The tables

Let's generate the tables for VARI:

```{r}
make_table_1("VARI")
```

VAT:

```{r}
make_table_1("VAT")
```

VAP:

```{r}
make_table_1("VAP")
```

Risk of HA BSI:

```{r}
make_table_1("habsi_risk")
```

HA BSI:

```{r}
make_table_1("habsi")
```

Risk of AL BSI:

```{r}
make_table_1("ALBSI_risk")
```

AL BSI:

```{r}
make_table_1("ALBSI")
```

Risk of CL BSI:

```{r}
make_table_1("CLBSI_risk")
```

CL BSI:

```{r}
make_table_1("CLBSI")
```

Tetanus

```{r}
make_table_1("Tetanus")
```

Death at ICU discharge:

```{r}
make_table_1("deathICU")
```

```{r include = FALSE}
#  as_hux(add_rownames = FALSE, add_colnames = TRUE) %>% 
#  insert_row(c(unname(unlist(tmp[1, 2:ncol(tmp)])), "")) %>%
#  add_footnote("- n = number of patients included in that summary statistic.", border = 0) %>%
#  add_footnote("- Values in the form of X(A, B) are medians followed by the 25th and 75th percentiles in parentheses.", border = 0) %>%
#  set_caption("Baseline characteristics of study population.") %>%
#  set_caption_pos("bottom") %>%
#  merge_cells(1, 2:3) %>%
#  merge_cells(1, 4:5) %>%
#  merge_cells(1, 6:7) %>%
#  set_bold(2, everywhere, value = TRUE) %>%
#  set_align(1, 2, "center") %>%
#  set_align(1, 4, "center") %>%
#  set_align(2, everywhere, "center") %>%
#  set_width(1) %>%
#  ht_theme_markdown(header_rows = 1:2)
```

## 3. Derivation of Aetiology of BSI

Number of BSI episodes:

```{r}
list(data2 %>% 
       group_by(nb_bsi) %>% 
       tally(),
     data2 %>%
       filter(habsi) %>% 
       group_by(nb_bsi) %>% 
       tally(),
     data2 %>% 
       filter(CLBSI) %>% 
       group_by(nb_bsi) %>% 
       tally()) %>% 
  reduce(left_join, "nb_bsi") %>% 
  mutate_all(replace_na, 0) %>% 
  setNames(c("nb BSI episodes", "all patients", "with HABSI", "with CLBSI"))
```

Number of pathogens in the first episode of BSI:

```{r}
list(data2 %>% 
       group_by(nb_path_bsi1) %>% 
       tally() %>% 
       drop_na(),
     data2 %>% 
       filter(habsi) %>% 
       group_by(nb_path_bsi1) %>% 
       tally() %>% 
       drop_na(),
     data2 %>% 
       filter(CLBSI) %>% 
       group_by(nb_path_bsi1) %>% 
       tally() %>% 
       drop_na()) %>% 
  reduce(left_join, "nb_path_bsi1") %>% 
  setNames(c("nb pathog in 1st BSI", "all patients", "with HABSI", "with CLBSI"))
```

Pathogens for cases with dual isolates in the first episode of BSI:

```{r}
data$MICBLD %>%
  filter(OrganismsNo > 1, episode < 2) %>% 
  select(PatientNo, pathogens) %>% 
  mutate(CLBSI = PatientNo %in% clbsi$PatientNo,
         ALBSI = PatientNo %in% albsi$PatientNo)
```

## 4. Derivation of Frequency of BSI aetiology

This function makes a table of pathogens' frequencies and proportions:

```{r include = FALSE, eval = FALSE}
make_path_table <- function(x) { 
  x %>% 
    pull(pathogens) %>% 
    strsplit(", ") %>%
    unlist() %>% 
    table() %>% 
    sort(TRUE) %>% 
    as.list() %>% 
    as_tibble() %>% 
    pivot_longer(everything(), names_to = "bacteria", values_to = "frequency") %>% 
    mutate(proportion = frequency / sum(.$frequency))
}
```

```{r}
make_path_table <- function(x) {
  x %>% 
    unite("episode", PatientNo, episode, sep = "-") %>% 
    select(episode, pathogens) %>% 
    separate_rows(pathogens, sep = ", ") %>% 
    distinct() %>% 
    mutate(nb_episodes = length(unique(episode))) %>% 
    group_by(pathogens) %>% 
    summarize(frequency   = n(),
              nb_episodes = unique(nb_episodes),
              proportion  = frequency / nb_episodes) %>% 
    arrange(desc(proportion))
}
```

### All BSI episodes

Frequencies and propotions of pathogens for all the BSI episodes:

```{r}
(path_freq <- data$MICBLD %>% 
  filter(episode > 0) %>% 
  make_path_table())
```

### First BSI episodes

Frequencies and proportions of pathogens for all the first BSI episodes:

```{r}
(path_freq_1step <- data$MICBLD %>% 
  filter(episode < 2) %>% 
  make_path_table())
```

### CLBSI (first) episodes

Reminder: patients are classified CLBSI or ALBSI based on their first BSI
episode. Here we consider only the first episodes of CLBSI patients. Frequencies
and proportions of pathogens for all the first CLBSI episodes:

```{r}
(path_freq_1stCLBSI <- data$MICBLD %>% 
  filter(PatientNo %in% clbsi$PatientNo, episode < 2) %>%
  make_path_table())
```

### ALBSI (first) episodes

Reminder: patients are classified CLBSI or ALBSI based on their first BSI
episode. Here we consider only the first episodes of CLBSI patients. Frequencies
and proportions of pathogens for all the first CLBSI episodes:

```{r}
(path_freq_1stALBSI <- data$MICBLD %>% 
  filter(PatientNo %in% albsi$PatientNo, episode < 2) %>%
  make_path_table())
```

### non-CLBSI (first) episodes

Frequencies and proportions of pathogens for all the non-CLBSI episodes:

```{r}
(path_freq_nonCLBSI <- data$MICBLD %>% 
  filter(! PatientNo %in% clbsi$PatientNo, episode < 2) %>%
  make_path_table())
```

### Pie charts of distributions

The colors of the bugs:

```{r}
colors <- setNames(c("#8dd3c7", "#ffffb3", "#bebada", "#fb8072", "#80b1d3",
                     "#fdb462","#b3de69","#fccde5", rep("#d9d9d9", 10)),
                   c("Klebsiella pneumoniae", "Pseudomonas aeruginosa", "Acinetobacter baumanii",
                     "Staphylococcus aureus", "Proteus mirabilis", "Enterococcus faecalis",
                     "Stenotrophomonas maltophilia", "Staphylococcus epidermidis",
                     "Escherichia coli", "Burkholderia seminalis", "Elizabethkingia meningoseptica",
                     "Klebsiella aerogenes", "Klebsiella oxytoca", "Providencia stuartii",
                     "Serratia marcescens", "Staphylococcus coagulase", "Staphylococcus haemolyticus",
                     "Staphylococcus xylosus"))
```

The following functions allows to write in italic:

```{r}
make_italic <- function(x) {
  as.expression(lapply(x, function(y) bquote(italic(.(y)))))
}
```

Tuning the `pie()` function:

```{r}
pie2 <- function(x) {
  x %$%
    setNames(proportion, pathogens) %>% 
    pie(., cex = 2 / 3, make_italic(names(.)), col = colors[names(.)])
}
```

All BSI episodes:

```{r fig.width = 8}
pie2(path_freq[c(1:7, 9:8, 10:18), ])
```

First BSI episodes:

```{r fig.width = 8}
pie2(path_freq_1step)
```

CLBSI (first) episodes:

```{r fig.width = 8}
pie2(path_freq_1stCLBSI[c(1:5, 8, 6:7, 9:13), ])
```

ALBSI (first) episodes:

```{r fig.width = 8}
pie2(path_freq_1stALBSI[c(1:6, 11:12, 7:10, 13:14), ])
```

Non-CLBSI (first) episodes:

```{r fig.width = 8}
pie2(path_freq_nonCLBSI[c(1:6, 9, 7:8, 10), ])
```

### Comparing distributions

Let's now compare the distribution of the main bugs which are the following:

```{r}
main_bugs <- c("Klebsiella pneumoniae",  "Pseudomonas aeruginosa",
               "Acinetobacter baumanii", "Staphylococcus aureus",
               "Enterococcus faecalis")
```

The following function tests the difference in the prevalence of one bug `x` in
the 5 different set-ups considered above (all BSI, first BSI episodes, etc...):

```{r eval = FALSE, include = FALSE}
fisher_test <- function(x) {
  fisher.test(matrix(
    c(path_freq[bacteria == x, "frequency"],
      path_freq_1step[bacteria == x, "frequency"],
      path_freq_1stCLBSI[bacteria == x, "frequency"],
      path_freq_1stALBSI[bacteria == x, "frequency"],
      path_freq_nonCLBSI[bacteria == x, "frequency"],
      sum(path_freq[, "frequency"]),
      sum(path_freq_1step[, "frequency"]),
      sum(path_freq_1stCLBSI[, "frequency"]),
      sum(path_freq_1stALBSI[, "frequency"]),
      sum(path_freq_nonCLBSI[, "frequency"])), 2, byrow = TRUE))$p
}
```

This function extracts the frequency of pathogen `y` in table `x`:

```{r}
  getx <- function(x, y) {
    x %>% 
      filter(pathogens == y) %>% 
      select(frequency) %>% 
      unlist()
  }
```

This function extracts the total number of episodes in table `x`:

```{r}
  getn <- function(x) {
    x %>%
      select(nb_episodes) %>%
      first() %>%
      first()
  }
```

Let's put all the pathogens tables into a list:

```{r}
table_list <- list(path_freq, path_freq_1step, path_freq_1stCLBSI, path_freq_1stALBSI, path_freq_nonCLBSI)
```

```{r}
fisher_test <- function(x) {
  c(function(y) getx(y, x), getn) %>% 
    map(function(f) map(table_list, f)) %>% 
    unlist() %>% 
    matrix(nrow = 2, byrow = TRUE) %>% 
    fisher.test() %>% 
    use_series(p.value)
}
```

Let's apply it to all the main bugs:

```{r}
map(main_bugs, fisher_test) %>% 
  unlist() %>% 
  setNames(main_bugs)
```

The following function computes the proportion of a bug `x`, with 95%-confidence
interval:

```{r eval = FALSE, include = FALSE}
calc_prop <- function(x) {
  list(unlist(prop.test(path_freq[x, "frequency"], sum(path_freq[x, "frequency"]))[c("estimate", "conf.int")]),
       unlist(prop.test(path_freq_1step[x, "frequency"], sum(path_freq_1step[x, "frequency"]))[c("estimate", "conf.int")]),
       unlist(prop.test(path_freq_1stCLBSI[x, "frequency"], sum(path_freq_1stCLBSI[x, "frequency"]))[c("estimate", "conf.int")]),
       unlist(prop.test(path_freq_1stALBSI[x, "frequency"], sum(path_freq_1stALBSI[x, "frequency"]))[c("estimate", "conf.int")]),
       unlist(prop.test(path_freq_nonCLBSI[x, "frequency"], sum(path_freq_nonCLBSI[x, "frequency"]))[c("estimate", "conf.int")])) %>% 
    reduce(rbind) %>% 
    as.data.frame()
}
```

```{r}
calc_prop <- function(x) {
  map2(map(table_list, getx, x),
       map(table_list, getn),
       function(x, n) unlist(prop.test(x, n)[c("estimate", "conf.int")])) %>% 
    reduce(rbind) %>% 
    as.data.frame()
}
```

Let's apply it to all the main bugs:

```{r}
prop_est <- map(main_bugs, calc_prop)
```

The following function puts together estimates (`x = 1`), lower bound (`x = 2`),
or upper bound (`x = 3`) of an object of the `prop_est` object:

```{r}
extract3 <- function(x) {
  prop_est %>%
    map(extract2, x) %>% 
    reduce(cbind)
}
```

Let's apply it for estimates, lower and upper bounds:

```{r}
prop_est2 <- map(1:3, extract3)
```

Let's draw the barplot:

```{r fig.width = 6, fig.height = 4}
barplot(prop_est2[[1]], beside = TRUE, col = colors[main_bugs], ylim = c(0, .6),
        names.arg = c("all BSI", "first BSI", "CLBSI", "ALBSI", "non-CLBSI"))
xs <- (2:30 - .5)[-seq(6, by = 6, le = 4)]
arrows(xs, as.numeric(prop_est2[[2]]), xs, as.numeric(prop_est2[[3]]), .05, 90, 3)
legend("topright", legend = main_bugs, fill = colors[main_bugs], bty = "n", text.font = 3)
```

## 5. Derivation of BSI incidence rate

The following function extracts estimate and confidence interval from the output
of `prop.test()`:

```{r}
extract_prop_test <- function(x) {
  unname(unlist(x[c("estimate", "conf.int")]))
}
```

The following function puts in good shape the estimate and confidence interval:

```{r}
put_in_shape <- function(x) {
  paste0(x[1], " (", x[2], ", ", x[3], ")")
}
```

The following function uses the 2 preceding functions to calculate proportions:

```{r}
calc_prop <- function(x, factor, digits) {
  x %>%
    as.list() %>% 
    reduce(prop.test) %>% 
    extract_prop_test() %>% 
    multiply_by(factor) %>% 
    round(digits) %>% 
    put_in_shape() %>% 
    paste0(" (", paste(x, collapse = " / "), ")")
}
```

### HABSI rate

The following function calculates HA BSI rates, with confidence interval:

```{r}
habsi_rate <- function(x, factor = 1000, digits = 2) {
  x %>% 
    select(habsi, rand2icu) %>% 
    drop_na() %>% 
    summarise_all(sum) %>% 
    unlist() %>% 
    calc_prop(factor, digits)
}
```

Let's try it:

```{r}
habsi_rate(data2)
```

### Proportion of patients with HABSI

The following function calculates the proportion of patients with HA BSI, with
confidence interval:

```{r}
habsi_prop <- function(x, factor = 100, digits = 1) {
  x %>% 
    select(habsi) %>% 
    drop_na() %>% 
    group_by(habsi) %>% # habsi is boolean
    tally() %>% 
    add_column(total = sum(.$n)) %>% 
    mutate(n = ifelse(habsi, n, total)) %>% 
    pull(n) %>% 
    rev() %>% 
    calc_prop(factor, digits)
}
```

Let's try it:

```{r}
habsi_prop(data2)
```

### Number of central line days

The following function calculates the number of CL days:

```{r}
nb_cl_days_fct <- function(x) {
  sum(x$nb_cl_days, na.rm = TRUE) %>% 
    as.numeric() %>% 
    as.character()
}
```

Let's try it:

```{r}
nb_cl_days_fct(data2)
```

### Central line utilization ratio

The following function calculates the CL utilization ratio:

```{r}
cl_utilization_ratio <- function(x, factor = 1000, digits = 2) {
  x %>% 
    select(nb_cl_days, rand2icu) %>% 
    drop_na() %>% 
    summarise_all(sum) %>% 
    unlist() %>% 
    calc_prop(factor, digits)
}
```

Let's try it:

```{r}
cl_utilization_ratio(data2)
```

### CLBSI rate

The following function calculates the CL BSI rate:

```{r}
clbsi_rate <- function(x, factor = 1000, digits = 2) {
  x %>% 
    select(CLBSI, nb_cl_days) %>% 
    drop_na() %>% 
    summarise_all(sum) %>% 
    unlist() %>% 
    calc_prop(factor, digits)
}
```

Let's try it:

```{r}
clbsi_rate(data2)
```

#### Putting together

The following function generates 1 row of the final table:

```{r}
make1row <- function(x) {
    map(list(habsi_rate, habsi_prop, nb_cl_days_fct, cl_utilization_ratio, clbsi_rate),
        function(f) f(x)) %>%
    as.data.frame(stringsAsFactors = FALSE) %>% 
    unname()
}
```

Let's try it:

```{r}
make1row(data2)
```

The following is a wrapper around the previous one and applies it by group:

```{r}
make1group <- function(x) {
  data2 %>% 
    filter(! is.na(.[[x]])) %>% 
    group_by(.[[x]]) %>% 
    group_modify(~ make1row(.x)) %>% 
    ungroup()
}
```

Let's try it:

```{r}
make1group("hospital")
```

let's consider the following groups:

```{r}
groups <- c("hospital", "Tetanus", "ALBSI", "tracheostomy", "deathICU", "death28", "death90")
```

This will be the names of the columns in the final data frame:

```{r}
col_names <- c("group", "HABSI rate", "proportion of HABSI", "# CL days", "CL utilization ratio", "CLBSI rate")
```

Let's compute the statistics for all the groups:

```{r}
out <- map(groups, make1group) %>% 
  c(list(as.data.frame(c("all", make1row(data2)), stringsAsFactors = FALSE)), .) %>% 
  lapply(setNames, col_names) %>% 
  lapply(mutate_at, 1, as.character)
```

The intermediate titles:

```{r}
inter <- lapply(groups, function(x) {
                          x %>%
                            c(rep("", 5)) %>% 
                            t() %>% 
                            as.data.frame(stringsAsFactors = FALSE) %>% 
                            setNames(col_names)
                        })
```

let's put everything together:

```{r}
lapply(1:7, function(x) c(out[x], inter[x])) %>%
  unlist(FALSE) %>% 
  c(out[8]) %>% 
  bind_rows()
```

## 6. Risk factors associated with BSI

### Utilitary functions

The following function transforms a continuous variable into a categorical
variable with equal amount of data in each category:

```{r}
makecat <- function(x, n = 3) {
  cut(x, quantile(x, seq(0, 1, le = n + 1), TRUE), include.lowest = TRUE)
}
```

Prints nice outputs for percentages:

```{r}
n_and_perc <- function(x, y) {
  paste0(x, " (", y, " %)")
}
```

The following function adds a single blank to each element of a list:

```{r}
add_single_blanks <- function(x) {
  x %>% 
    map(~ c("", .x)) %>% 
    unlist()
}

```

The following function extract the $p$-values of each level of each variable of
a Cox regression model `x`:

```{r}
extract_levels_pvalues <- function(x) {
  x %>% 
    summary() %>% 
    use_series("coefficient") %>% 
    magrittr::extract(, "Pr(>|z|)")
}
```

### Risk factors

The following function computes the risk factors table:

```{r}
risk_factors <- function(event, time, digit1 = 1, digits = 3) {
# Making the data:
  data <- data2 %>% 
    select({{event}}, Sex, age, hospital, apache, charlson, sepsis, Tetanus, CNS,
           dia_co, Mode, had_catheter, had_arterial, tracheostomy, adm2icu, {{time}}) %>% 
    mutate_at("adm2icu", as.numeric) %>% 
    mutate_at(vars(age, adm2icu, apache), makecat)

# Adding habsi in case not in:
  if (! "habsi" %in% names(data)) data$habsi <- data2$habsi
  
# Generating variables sets:
  event_time <- data %>%
    select({{event}}, {{time}}) %>%
    names()
  event_var <- event_time[1]
  time_var <- event_time[2]
  variables <- setdiff(names(data), event_time)

# The following function gives numbers and percentages:
  n_and_percentage <- function(var) {
    x <- as.numeric(table(data[[var]], data[[event_var]]))
    map2(x, round(100 * x / sum(x), digit1), n_and_perc) %>%
      unlist() %>%
      matrix(ncol = 2)
  }

# The numbers and percentages for all the variables:
  numbers <- lapply(variables, n_and_percentage) %>%
    reduce(rbind)

# The following function uses a function f on all the variables and adds space
# between each variable:
  calc_uni_single <- function(f) {
    variables %>% 
      lapply(f) %>% 
      add_single_blanks()
  }  

# The following function extracts the coefficients of a Cox regression and puts
# them into shape:
  cox_coef <- function(x) {
    y <- Surv(data[[time_var]], data[[event_var]])
    coxph(y ~ data[[x]]) %>%
      (function(x) map(c(coef, confint), function(f) f(x))) %>%
      reduce(cbind) %>%
      exp() %>%
      round(digits) %>%
      apply(1, put_in_shape) %>%
      as.matrix()
  }

# The following function runs a Cox regression and extracts the p-values for
# each level of each variable:
  cox_p1 <- function(x) {
    y <- Surv(data[[time_var]], data[[event_var]])
    coxph(y ~ data[[x]]) %>%
      extract_levels_pvalues() %>%
      round(digits)
  }

# The following function runs a Cox regression and extracts the p-values for
# each variable:
  cox_p2 <- function(x) {
    y <- Surv(data[[time_var]], data[[event_var]])
    coxph(y ~ data[[x]]) %>%
      anova() %>%
      extract2("Pr(>|Chi|)") %>%
      magrittr::extract(2) %>%
      round(digits)
  }
  
# The number of levels per variable:
  nb_lev <- sapply(variables, function(x) length(unique(na.exclude(data[[x]]))))
   
# The function that adds the blanks:
  add_multiple_blanks <- function(x) {
    blanks <- map(nb_lev - 1, ~ rep("", .x))
    map2(x, blanks, ~ c(.x, .y))
  }
    
# The p-values of each variable from univariate models:
  p_uni2 <- variables %>%
    sapply(cox_p2) %>%
     add_multiple_blanks() %>%
     unlist()
  
# The multivariate model:
  m <- coxph(Surv(data[[time_var]], data[[event_var]]) ~ ., data[, variables])
  
# The following function splits a data frame by variables, according to the
# number of levels in each variable:
  split_by_variable <- function(x) {
    split(x, rep(seq_along(nb_lev), nb_lev - 1))
  }

# Coefficients of the multivariate model:
  c_multi <- m %>%
    (function(x) map(c(coef, confint), function(f) f(x))) %>%
    reduce(cbind) %>%
    exp() %>%
    round(digits) %>%
    apply(1, put_in_shape) %>%
    split_by_variable() %>%
    map(~ c("", .x)) %>%
    unlist()

# p-values of each level of each variable of the multivariate model:
  p_multi1 <- m %>%
    extract_levels_pvalues() %>%
    round(digits) %>%
    split_by_variable() %>%
    add_single_blanks()

# p-values of each variable of the multivariate model, corrected for confoundings:
  p_multi2 <- m %>%
    car::Anova(test = "LR") %>%
    extract2("Pr(>Chisq)") %>%
    round(digits) %>%
    add_multiple_blanks() %>%
    unlist()

# Levels:
  levels <- data[, variables] %>% 
    mutate_all(as.factor) %>%
    lapply(levels) %>%
    unlist()
  
# variables:
  vars <- variables %>%
    add_multiple_blanks %>%
    unlist()

# Putting together:
  cbind(vars, levels, numbers, calc_uni_single(cox_coef),
        calc_uni_single(cox_p1), p_uni2, c_multi, p_multi1, p_multi2) %>%
    as.data.frame(stringsAsFactors = FALSE) %>% 
    remove_rownames() %>% 
    setNames(c("variables", "levels", "non event", "event", "rate ratio uni",
               "p level 1", "p variable 1", "rate ratio multi", "p level 2", "p variable 2 "))
}
```

Let's run it:

```{r}
risk_factors(habsi, time2bsi)
```

## 7. Risk factors associated with mortality

Same function as before, with different event:

```{r}
risk_factors(death90, DOD)
```

## 8. Kaplanâ€“Meier analysis

### The data

Here are the variables we need:

```{r}
data3 <- data2 %>% 
  select(habsi, DOD, rand2hos, deathICU, death28, death90, CLBSI) %>% 
  mutate(timeICU = as.integer(rand2hos),
         time28  = ifelse(DOD < 29, DOD, 28),
         time90  = DOD) %>% 
  select(-DOD, -rand2hos)
```

Which looks like this:

```{r}
data3
```

### Tables of contingency

The distributions of events as functions of HA BSI:

```{r}
with(data3, table(habsi, deathICU))
with(data3, table(habsi, death28))
with(data3, table(habsi, death90))
```

The distributions of events as functions of CL BSI:

```{r}
with(data3, table(CLBSI, deathICU))
with(data3, table(CLBSI, death28))
with(data3, table(CLBSI, death90))
```

And the relationship between HA BSI and CL BSI:

```{r}
with(data3, table(CLBSI, habsi))
```

### Utilitary functions

This function splits a vector `x` according to the indexes given by the vector
`pos`:

```{r}
splitat <- function(x, pos) {
  split(x, cumsum(seq_along(x) %in% pos))
}
```

This functions transform a vector of $x$ coordinates so that it can easily be
plotted in staircase style:

```{r}
transform_x <- function(x, at) {
  tmp <- splitat(x, at)
  time2 <- tmp[-1] %>%
    map(~ c(first(.x), .x)) %>% 
    c(first(tmp), .) %>% 
    unlist()

}
```

This functions transform a vector of $y$ coordinates so that it can easily be
plotted in staircase style:

```{r}
transform_y <- function(x, at) {
  tmp <- splitat(x, at)
  tmp[-length(tmp)] %>%
    map(~ c(.x, last(.x))) %>% 
    c(last(tmp)) %>% 
    unlist()
} 
```

### A function to plot events occurences

```{r}
plotevent <- function(a, ylim = 0:1, col_line = "black", col_area = "grey", add = FALSE) {
  
  snames <- c("time", "surv", "lower", "upper")
  
  tmp <- a %>%
    unclass() %>%
    magrittr::extract(snames) %>% 
    map2(c(0, 1, 1, 1), ~ c(.y, .x))
  
  sel <- with(tmp, sort(c(which(! near(diff(lower), 0)), which(! near(diff(upper), 0))) + 1))
  
  c(transform_x, transform_y, transform_y, transform_y) %>% 
    map2(tmp, ~ .x(.y, sel)) %>% 
    setNames(snames) %>%
    with({
      if (! add)
        plot(time, 1 - surv, xlab = "time (days)", ylab = "proportion dead", ylim = ylim, type = "n")
      polygon(c(time, rev(time)), 1 - c(lower, rev(upper)), col = col_area, border = NA)
      lines(time, 1 - surv, col = col_line)
    })
}
```

### Events occurences as functions of time

```{r}
colors <- c("#7fc97f", "#beaed4", "#fdc086")
adjcol <- adjustcolor(colors, .5)
ylim <- c(0, .5)
plotevent(survfit(Surv(timeICU, deathICU) ~ 1, data = data3), ylim, colors[1], adjcol[1])
plotevent(survfit(Surv(time90 , death90)  ~ 1, data = data3), ylim, colors[2], adjcol[2], add = TRUE)
plotevent(survfit(Surv(time28 , death28)  ~ 1, data = data3), ylim, colors[3], adjcol[3], add = TRUE)
legend("topright", legend = c("at ICU discharge", "at day 90", "at day 28"),
       fill = adjcol, col = colors, lty = 1, bty = "n", border = NA)
```

### Events occurences as functions of time and BSI status

Graph parameters:

```{r}
colors <- c("#e41a1c", "#377eb8")
adjcol <- adjustcolor(colors, .5)
add_legend <- function() {
  legend("topleft", legend = c("HA BSI", "non HA BSI"),
         fill = adjcol, col = colors, lty = 1, bty = "n", border = NA)
}
```

Death at ICU:

```{r}
plotevent(survfit(Surv(timeICU, deathICU) ~ 1, data = filter(data3,   habsi)), ylim, colors[1], adjcol[1])
plotevent(survfit(Surv(timeICU, deathICU) ~ 1, data = filter(data3, ! habsi)), ylim, colors[2], adjcol[2], add = TRUE)
add_legend()
```

Death at day 28:

```{r}
plotevent(survfit(Surv(time28, death28) ~ 1, data = filter(data3,   habsi)), ylim, colors[1], adjcol[1])
plotevent(survfit(Surv(time28, death28) ~ 1, data = filter(data3, ! habsi)), ylim, colors[2], adjcol[2], add = TRUE)
add_legend()
```

Death at day 90:

```{r}
plotevent(survfit(Surv(time90, death90) ~ 1, data = filter(data3,   habsi)), ylim, colors[1], adjcol[1])
plotevent(survfit(Surv(time90, death90) ~ 1, data = filter(data3, ! habsi)), ylim, colors[2], adjcol[2], add = TRUE)
add_legend()
```

### Events occurences as functions of time and type of BSI status

```{r}
colors <- c("#377eb8", "#984ea3", "#ff7f00")
adjcol <- adjustcolor(colors, .5)
ylim <- c(0, .7)
add_legend <- function() {
  legend("topleft", legend = c("non HA BSI", "CLBSI", "non CL BSI"),
         fill = adjcol, col = colors, lty = 1, bty = "n", border = NA)
}
```

Death at ICU:

```{r}
plotevent(survfit(Surv(timeICU, deathICU) ~ 1, data = filter(data3, ! habsi)), ylim, colors[1], adjcol[1])
plotevent(survfit(Surv(timeICU, deathICU) ~ 1, data = filter(data3,   CLBSI)), ylim, colors[2], adjcol[2], add = TRUE)
plotevent(survfit(Surv(timeICU, deathICU) ~ 1, data = filter(data3, ! CLBSI)), ylim, colors[3], adjcol[3], add = TRUE)
add_legend()
```

Death at day 28:

```{r}
plotevent(survfit(Surv(time28, death28) ~ 1, data = filter(data3, ! habsi)), ylim, colors[1], adjcol[1])
plotevent(survfit(Surv(time28, death28) ~ 1, data = filter(data3,   CLBSI)), ylim, colors[2], adjcol[2], add = TRUE)
plotevent(survfit(Surv(time28, death28) ~ 1, data = filter(data3, ! CLBSI)), ylim, colors[3], adjcol[3], add = TRUE)
add_legend()
```

Death at day 90:

```{r}
plotevent(survfit(Surv(time90, death90) ~ 1, data = filter(data3, ! habsi)), ylim, colors[1], adjcol[1])
plotevent(survfit(Surv(time90, death90) ~ 1, data = filter(data3,   CLBSI)), ylim, colors[2], adjcol[2], add = TRUE)
plotevent(survfit(Surv(time90, death90) ~ 1, data = filter(data3, ! CLBSI)), ylim, colors[3], adjcol[3], add = TRUE)
add_legend()
```

