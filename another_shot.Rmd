---
title: "Another shot"
csl: the-american-naturalist.csl
output:
  html_document:
    theme: cerulean
    toc: yes
  pdf_document:
    toc: yes
<!-- bibliography: references.bib -->
editor_options: 
  chunk_output_type: console
---

<!--
IMAGES:
Insert them with: ![alt text](image.png)
You can also resize them if needed: convert image.png -resize 50% image.png
If you want to center the image, go through HTML code:
<div style="text-align:center"><img src ="image.png"/></div>

REFERENCES:
For references: Put all the bibTeX references in the file "references.bib"
in the current folder and cite the references as @key or [@key] in the text.
Uncomment the bibliography field in the above header and put a "References"
title wherever you want to display the reference list.
-->

<style type="text/css">
.main-container {
  max-width: 1370px;
  margin-left: auto;
  margin-right: auto;
}
</style>

```{r general options, include = FALSE}
knitr::knit_hooks$set(
  margin = function(before, options, envir) {
    if (before) par(mgp = c(1.5, .5, 0), bty = "n", plt = c(.105, .97, .13, .97))
    else NULL
  },
  prompt = function(before, options, envir) {
    options(prompt = if (options$engine %in% c("sh", "bash")) "$ " else "> ")
  })

knitr::opts_chunk$set(margin = TRUE, #prompt = TRUE, comment = "", collapse = TRUE,
                      cache = FALSE, autodep = TRUE,
                      dev.args = list(pointsize = 11), fig.height = 3.5,
                      fig.width = 4.24725, fig.retina = 2, fig.align = "center")

options(width = 137)
#options(width = 253)
```

## 0. Packages

Installing the required packages:

```{r}
required <- c("dplyr", "lubridate", "magrittr", "purrr", "readxl", "tibble", "tidyr")
to_install <- setdiff(required, row.names(installed.packages()))
if (length(to_install)) install.packages(to_install)
```

Loading `magrittr` for interactive use:

```{r, message = FALSE}
library(magrittr)
library(dplyr)
library(purrr)
library(tidyr)
library(lubridate)
library(tibble)
library(stringr)
library(C306)
#library(huxtable)
```

## 1. Putting the data in shape

### Accessory functions

```{r}
yesno2bool <- function(x) {
  na_if(x, "NA") == "Yes"
}
```

### Reading data
The data are in this file:

```{r}
data_file <- "19-8-2019-CTU16HN_Data.xls.xlsx"
```

The list of sheets that we are interested in:

```{r}
sheets <- c("ADM", "AIR", "APAC", "DAILY1n2", "ENR", "FINISH", "FU", "FU_DAY90", "MICBLD")
```

Non-eligible patients:

```{r}
non_eligible_IDs <- c("020-007", "020-012", "020-063", "003-089", "003-053", "003-110")
```

Reading all the sheets of this file and transforming the dates:

```{r warning = FALSE}
data <- sheets %>%
  lapply(readxl::read_excel, path = data_file) %>% 
  lapply(function(x) dplyr::mutate_if(x, function(y) "POSIXct" %in% class(y), as.Date)) %>% 
  setNames(sheets)
```

```{r include = FALSE, eval = FALSE}
sheets <- readxl::excel_sheets("19-8-2019-CTU16HN_Data.xls.xlsx")
data_all <- sheets %>%
  lapply(readxl::read_excel, path = data_file) %>% 
  lapply(function(x) dplyr::mutate_if(x, function(y) "POSIXct" %in% class(y), as.Date)) %>% 
  setNames(sheets)
```

```{r}
data$FINISH %<>% 
  select(PatientNo, IsCompleted, IsAgree, HosDate, ICUDate, OutCome, HosSame) %>%
  mutate_at("IsAgree", yesno2bool) %>% 
  rename(ICUDateFINISH = ICUDate) %>% 
  distinct()
```

`IsComplete == 1`: completed until discharge or death

`IsAgree == "Yes"`: agree to use data for those who didn't complete.

`HosDate`: date of discharge

`ICUDate`: date of this study ward discharge

`OutCome`: death or not

Admission information:

```{r}
data$ADM %<>% 
  select(PatientNo, HospitalDate, NKQ, Tetanus, Pneumonia, Sepsis, Septic, CNS,
         COPD, CVA, Myo, SpOther, DiaCo, DiaDa, Mode, CongI_III, Peri, Cere, Deme,
         Chro, Conn, Peptic, Hemi, ModeSeve, Meta, AIDS, AnyMa, CongIV, Elective,
         Emergency, Source, Mild, Seve, ICUDate) %>%
  mutate_at(vars(Myo, DiaCo, DiaDa, Mode, CongI_III, Peri, Cere, Deme, Chro, Conn,
                 Peptic, Hemi, ModeSeve, Meta, AIDS, AnyMa, CongIV, Elective,
                 Emergency, Mild, Seve), yesno2bool) %>% 
  rename(ICUDateADM = ICUDate) %>% 
  distinct()
```

The following function corrects the names of the bacteria:

```{r}
correct_names <- function(x) {
  x %>% 
    str_to_sentence() %>% 
    str_replace("Staph epidermidis"                 , "Staphylococcus epidermidis") %>%
    str_replace("Staph haemolyticus"                , "Staphylococcus haemolyticus") %>%
    str_replace("S.marcescens"                      , "Serratia marcescens") %>% 
    str_replace("Elizabethkingie"                   , "Elizabethkingia") %>% 
    str_replace("Enterobacter aerogenes"            , "Klebsiella aerogenes") %>% 
    str_replace("Proteus mirasilis"                 , "Proteus mirabilis") %>% 
    str_replace("Staphylococcin epidermidis"        , "Staphylococcus epidermidis") %>% 
    str_replace("Staphylococcs xylosus"             , "Staphylococcus xylosus") %>% 
    str_replace("Stenotrophomonas malto"            , "Stenotrophomonas maltophilia") %>% 
    str_replace("Enterococcus fecalis"              , "Enterococcus faecalis") %>% 
    str_replace("Stenotrophomonas maltophiliaphilia", "Stenotrophomonas maltophilia") %>% 
    str_replace(" \\(-\\)", "")
}
```

Blood microbiology:

```{r}
data$MICBLD %<>% 
  select(PatientNo, HAIDate, OrganismsNo, Iden1, Iden2, OtherIden1, OtherIden2,
         IsOxac1, IsESBL1, IsColistin1, IsOxac2, IsESBL2, IsColistin2) %>% 
  mutate_at(vars(IsOxac1, IsESBL1, IsColistin1, IsOxac2, IsESBL2, IsColistin2), yesno2bool) %>% 
  mutate_at(vars(OtherIden1, OtherIden2), correct_names) %>% 
  mutate_at(vars(Iden1, Iden2), recode, `1` = "Pseudomonas aeruginosa",
                                        `2` = "Klebsiella pneumoniae",
                                        `3` = "Staphylococcus aureus",
                                        `4` = "Acinetobacter baumanii",
                                        `5` = "Escherichia coli",
                                        `6` = "otherpath") %>% 
  mutate(Iden1 = ifelse(Iden1 == "otherpath", OtherIden1, Iden1),
         Iden2 = ifelse(Iden2 == "otherpath", OtherIden2, Iden2),
         condition = Iden1 < Iden2,
         Iden1b = ifelse(condition, Iden1, Iden2),
         Iden2b = ifelse(condition, Iden2, Iden1)) %>% 
  unite("pathogens", Iden1b, Iden2b, sep = ", ") %>% 
  mutate(pathogens = ifelse(pathogens == "NA, NA", Iden1, pathogens)) %>% 
  select(-OtherIden1, -OtherIden2, -condition) %>% 
  distinct()
```

`HAIDate`: date of sampling

Daily monitoring:

```{r}
data$DAILY1n2 %<>% 
  select(PatientNo, CVCCount, VSDate, Arterial, TempMax, TempMin) %>% 
  mutate_at("Arterial", yesno2bool) %>% 
  distinct()
```

`CVCCount`: number of central venous catheters.

Patient information:

```{r}
data$ENR %<>% select(PatientNo, Sex, Age, YOB, RandDate) %>% 
  distinct()
```

Ventilation:

```{r}
data$AIR %<>% 
  select(PatientNo, IsTrach, TrachDate) %>% 
  mutate_at("IsTrach", yesno2bool) %>% 
  distinct()
```

Apache code variables:

```{r}
data$APAC %<>% 
  select(PatientNo, HbA1c, Sodium, Potassium, Creatinine, Haematocrit, BloodCell,
         Systolic, Diastolic, PuHightest, PuLowest, ResHightest, ResLowest, FiO2,
         PaO2, PaCO2, HCO3, ArterialpH, GlasgowScore, Motor, Verbal, Eyes, Total) %>% 
  distinct()
```

Follow-ups:

```{r}
data$FU %<>% select(PatientNo, DeathDate28, Status28, Date28) %>% # We probably don't need this any more for now
  distinct()
```

and:

```{r}
data$FU_DAY90 %<>% select(PatientNo, DeathDate90, Status90, Date90) %>% # We probably don't need this any more for now
  distinct()
```

### Microbiology variables (MICBLD)

The following function adds the episode variable:

```{r}
add_episode <- function(x) {
# it's not clear why the filter() / right_join() doesn't work here and has to be
# after the group_modify() call below.
  x %>% 
#    filter(OrganismsNo > 0) %>% 
    add_column(episode = cumsum(c(1, ! (diff(.$HAIDate) < 2 | (diff(.$HAIDate) < 3 & diff(as.integer(as.factor(.$pathogens))) < 1)))))# %>% 
#    right_join(select(x, PatientNo, HAIDate))
}
```

Let's try it:

```{r}
data$MICBLD %>% 
  filter(OrganismsNo > 0) %>% 
  arrange(HAIDate) %>% 
  filter(PatientNo == "020-526") %>% 
  add_episode()
```

Let's add it to the whole data set:

```{r}
data$MICBLD %<>% 
  filter(OrganismsNo > 0) %>% 
  arrange(HAIDate) %>% 
  group_by(PatientNo) %>% 
  group_modify(~ add_episode(.x)) %>% 
  ungroup() %>% 
  right_join(select(data$MICBLD, PatientNo, HAIDate), c("PatientNo", "HAIDate"))
```

Patients with BSI, showing the date of the first BSI episode:

```{r}
first_bsi <- data$MICBLD %>% 
  filter(OrganismsNo > 0) %>% 
  arrange(HAIDate) %>% 
  group_by(PatientNo) %>% 
  summarise(first_BSI = first(HAIDate))
```

Numbers of BSI episodes:

```{r}
nb_bsi <- data$MICBLD %>% 
  filter(OrganismsNo > 0) %>% 
  group_by(PatientNo) %>% 
  summarise(nb_bsi = length(unique(episode)))
```

Number of pathogens in the first episode of BSI:

```{r}
nb_path_bsi1 <- data$MICBLD %>% 
  filter(episode < 2) %>% 
  group_by(PatientNo) %>% 
  summarise(nb_path_bsi1 = length(unique(first(strsplit(paste(unlist(pathogens), collapse = ", "), ", ")))))
```

### Daily monitoring variables (DAILY1n2)

Patients with catheter:

```{r}
had_catheter <- data$DAILY1n2 %>% 
  group_by(PatientNo) %>% 
  summarise(had_catheter = any(CVCCount > 0))
```

Patients with arterial line during ICU stay:

```{r}
had_arterial <- data$DAILY1n2 %>% 
  group_by(PatientNo) %>% 
  summarise(had_arterial = any(Arterial))
```

Patients at risk of CLBSI (i.e. with central line placement for at least 2
consecutive days):

```{r}
clbsi_risk <- data$DAILY1n2 %>% 
  filter(CVCCount > 0) %>% 
  group_by(PatientNo) %>% 
  summarise(CLBSI_risk = ifelse(length(VSDate) > 1, any(diff(VSDate) < 2), FALSE))
```

Patients with CLBSI

```{r}
clbsi <- left_join(first_bsi, data$DAILY1n2, "PatientNo") %>% 
  filter(first_BSI - VSDate < 6, CVCCount > 0) %>% 
  group_by(PatientNo) %>% 
  summarise(CLBSI = ifelse(length(VSDate) > 1, any(diff(VSDate) < 2), FALSE))
```

Patients at risk of ALBSI:

```{r}
albsi_risk <- data$DAILY1n2 %>% 
  filter(Arterial) %>% 
  group_by(PatientNo) %>% 
  summarise(ALBSI_risk = ifelse(length(VSDate) > 1, any(diff(VSDate) < 2), FALSE))
```

Patients with ALBSI:

```{r}
albsi <- left_join(first_bsi, data$DAILY1n2, "PatientNo") %>% 
  filter(first_BSI - VSDate < 6, Arterial) %>% 
  group_by(PatientNo) %>% 
  summarise(ALBSI = ifelse(length(VSDate) > 1, any(diff(VSDate) < 2), FALSE))
```

Total number of Central line days:

```{r}
nb_cl_days <- left_join(data$DAILY1n2, first_bsi, "PatientNo") %>% 
  filter(is.na(first_BSI) | VSDate < first_BSI, CVCCount > 0) %>% 
  group_by(PatientNo) %>% 
  tally() %>%
  rename(nb_cl_days = n)
```

Total number of arterial line days:

```{r}
nb_al_days <- left_join(data$DAILY1n2, first_bsi, "PatientNo") %>% 
  filter(is.na(first_BSI) | VSDate < first_BSI, Arterial) %>% 
  group_by(PatientNo) %>% 
  tally() %>% 
  rename(nb_al_days = n)
```

### Other variables

Need to be calculated now because the calculation of APACHE-II need the age
variable that is calculated here.

```{r}
data2 <- c(data[setdiff(names(data), c("DAILY1n2", "MICBLD"))],
           list(first_bsi, clbsi_risk, clbsi, albsi_risk, albsi, nb_cl_days,
                nb_al_days, nb_bsi, nb_path_bsi1, had_catheter, had_arterial)) %>% 
  reduce(left_join, by = "PatientNo") %>% 
  mutate_at(c("CLBSI_risk", "CLBSI", "ALBSI_risk", "ALBSI", "had_catheter", "had_arterial"),
            replace_na, FALSE) %>% 
  mutate_at(c("nb_cl_days", "nb_al_days", "nb_bsi"), replace_na, 0) %>% 
  mutate(
# at risk of hopital acquired blood stream infection:
         habsi_risk   = replace_na(HosDate - HospitalDate > 1, FALSE),
# hospitals:
         hospital     = recode(sub("-.*$", "", PatientNo),
                                 `003` = "HTD",
                                 `020` = "NHTD",
                                 `103` = "BVTV"),
# ages:
         age          = ifelse(is.na(Age),
                               round(as.numeric(RandDate - ymd(paste(YOB, "0101"))) / 365),
                               Age),
# HABSI:
         habsi        = nb_bsi > 0,
# recode NKQ:
         NKQ          = recode(NKQ, `1` = "tracheostomy", `2` = "mouth"),
# tracheostomy:
         tracheostomy = NKQ == "mouth" | IsTrach,
         tracheostomy = ifelse(habsi, tracheostomy & TrachDate < first_BSI, tracheostomy),
# sepsis:
         sepsis = Sepsis | Septic,
# comorbidity of diabetes:
         dia_co       = DiaCo | DiaDa | HbA1c >= 6.5,
# durations:
         rand2icu     = ICUDateFINISH - RandDate,
         rand2hos     = HosDate - RandDate,
         adm2icu      = ICUDateFINISH - HospitalDate,
         adm2hos      = HosDate - HospitalDate,
         ICUstay      = ICUDateFINISH - ICUDateADM,
# death at hospital discharge:
#         deathHOSdis  = OutCome < 3,
# death at ICU discharge:
#         deathICUdis  = deathHOSdis & HosDate == ICUDateFINISH,
# death 28 days:
#         death28days  = Status28 == "Died",
# death 90 days:
#         death90days  = Status90 == "Died",
# other pathogen:
         otherpath    = ! is.na(SpOther),
# transfer from other hospital:
         otherhosp    = Source == "Other hospital")
```

Nothing to worry about the 8 failed to parse.

### Adding Charlson scores

Computing and adding the Charlson scores to `data2`:

```{r}
charlson <- data2 %>% 
  select(PatientNo, Myo, CongI_III, Peri, Cere, Deme, Chro, Conn, Peptic,
         Mild, DiaCo, Hemi, ModeSeve, DiaDa, AnyMa, Mode, Meta, AIDS) %>% 
  mutate_all(replace_na, FALSE) %>% 
  mutate_if(is.logical, as.integer) %>% 
  mutate_at(vars(Hemi, ModeSeve, DiaDa, AnyMa), function(x) 2 * x) %>% 
  mutate_at(vars(Meta, AIDS), function(x) 6 * x) %>% 
  mutate(Mode         = 3 * Mode) %>% 
  mutate(charlson     = select_if(., is.numeric) %>% rowSums(),
         charlson_cat = cut(charlson, c(-Inf, 0, 2, 4, Inf)) %>% as.character())
```

Let's compare with Thinh:

```{r}
charlson_trinh <- readRDS("charlson_score.rds")

setdiff(charlson$PatientNo, charlson_trinh$PatientNo)
setdiff(charlson_trinh$PatientNo, charlson$PatientNo)

marc <- charlson %>% 
  arrange(PatientNo) %>% 
  select(-PatientNo, -charlson_cat) %>% 
  mutate_all(as.integer)

trinh <- charlson_trinh %>% 
  arrange(PatientNo) %>% 
  select(-PatientNo) %>% 
  mutate_all(as.integer)

any(! unlist(map2(marc, trinh, identical)))
```

Let's add to `data2`:

```{r}
data2 %<>% left_join(select(charlson, PatientNo, charlson_cat), "PatientNo")
```

### Adding APACHE-II scores

The Apache-II Score provides an estimate of ICU mortality based on a number of
laboratory values and patient signs taking both acute and chronic disease into
account.

**Note:** The data used should relate to the 24 hours prior to randomisation and
the worst (highest scoring) recorded values should be used.

This function below computes score functions:

```{r}
make_score_functions <- function(scores, values) {
  function(x) scores[cut(x, c(-Inf, values, +Inf), right = FALSE)]
}
```

The parameters values for the score functions:

```{r}
apache_physio <- list(
  temp = list(
    scores = c(4:0, 1, 3, 4),
    values = c(30, 32, 34, 36, 38.5, 39, 41)),
  bp = list(
    scores = c(4, 2, 0, 2:4),
    values = c(50, 70, 110, 130, 160)),
  hr = list(
    scores = c(4, 3, 2, 0, 2, 3, 4),
    values = c(40, 55, 70, 110, 140, 180)),
  rr = list(
    scores = c(4, 2, 1, 0, 1, 3, 4),
    values = c(6, 10, 12, 25, 35, 50)),
  pao2 = list(
    scores = c(4, 3, 1, 0),
    values = c(55, 61, 70)),
  aa_gradient = list(
    scores = c(0, 2:4),
    values = c(200, 350, 500)),
  ph = list(
    scores = c(4, 3, 2, 0, 1, 3, 4),
    values = c(7.15, 7.25, 7.33, 7.5, 7.6, 7.7)),
  hco3 = list(
    scores = c(4, 3, 2, 0, 1, 3, 4),
    values = c(15, 18, 23, 32, 41, 52)),
  na = list(
    scores = c(4:2, 0:4),
    values = c(111, 120, 130, 150, 155, 160, 180)),
  k = list(
    scores = c(4, 2:0, 1, 3, 4),
    values = c(2.5, 3, 3.5, 5.5, 6, 7)),
  creatinine = list(
    scores = c(2, 0, 2:4),
    values = c(0.6, 1.5, 2, 3.5)),
  hematocrit = list(
    scores = c(4, 2, 0:2, 4),
    values = c(20, 30, 46, 50, 60)),
  wbc = list(
    scores = c(4, 2, 0:2, 4),
    values = c(1, 3, 15, 20, 40)),
  age = list(
    scores = rev(c(0, 2, 3, 5, 6)),
    values = c(44, 54, 64, 74)))
```

Let's generate the score functions:

```{r}
score_fcts <- setNames(lapply(apache_physio,
                              function(x) make_score_functions(x$scores, x$values)), 
                       names(apache_physio))
```

Let's see an example:

```{r}
head(score_fcts$temp(data$DAILY1n2$TempMax), 100)
```

Computing and adding the apache scores to `data2`:

```{r}
apache <- data$APAC %>% 
  left_join(select(data2, PatientNo, age, RandDate, Mode, CongIV, Seve, AIDS, Elective, Emergency), "PatientNo") %>% 
  left_join(select(data$DAILY1n2, PatientNo, VSDate, TempMax, TempMin), c("PatientNo", "RandDate" = "VSDate")) %>% 
  mutate(a = score_fcts$temp(TempMax),
         b = score_fcts$temp(TempMin),
         temp_score = ifelse(a < b, b, a),
         map_score  = score_fcts$bp((2 * Diastolic + Systolic) / 3),
         a = score_fcts$hr(PuHightest),
         b = score_fcts$hr(PuLowest),
         hr_score = ifelse(a < b, b, a),
         a = score_fcts$rr(ResHightest),
         b = score_fcts$rr(ResLowest),
         rr_score = ifelse(a < b, b, a),
         
         PaCO2 = ifelse(is.na(PaCO2), HCO3 / (0.03 * 10 ^ (ArterialpH - 6.1)), PaCO2),
         aa_gradient = 713 * FiO2 - PaCO2 / .8 - PaO2,
#         a_score = ifelse(is.na(aa_gradient) | FiO2 < .5, score_fcts$pao2(PaO2), score_fcts$aa_gradient(aa_gradient)),
         a_score = ifelse(is.na(FiO2) | FiO2 < .5, score_fcts$pao2(PaO2), score_fcts$aa_gradient(aa_gradient)),
         
         ph_score = ifelse(is.na(ArterialpH), score_fcts$hco3(HCO3), score_fcts$ph(ArterialpH)),
         
         na_score = score_fcts$na(Sodium),
         k_score = score_fcts$k(Potassium),
         creatinine_score = score_fcts$creatinine(Creatinine),
         hematocrit_score = score_fcts$hematocrit(Haematocrit),
         wbc_score = score_fcts$wbc(BloodCell),
         gcs_score = ifelse(is.na(GlasgowScore),
                            NA,
                            15 - ifelse(GlasgowScore == "Preintubation",
                                        ifelse(is.na(Motor) | is.na(Verbal) | is.na(Eyes) |
                                                 Motor == 0 | Verbal == 0   | Eyes == 0   |
                                                 Motor == 9 | Verbal == 9   | Eyes == 9,
                                               Total,
                                               Motor + Verbal + Eyes),
                                        15)),
#         gcs_score = 15 - ifelse(GlasgowScore == "Preintubation",
#                                 ifelse(is.na(Motor) | is.na(Verbal) | is.na(Eyes) |
#                                          Motor == 0 | Verbal == 0   | Eyes == 0   |
#                                          Motor == 9 | Verbal == 9   | Eyes == 9,
#                                        Total,
#                                        Motor + Verbal + Eyes),
#                                 15),
         age_score = score_fcts$age(age),
         c_score = ifelse(Mode + CongIV + Seve + AIDS < 1,
                          0,
                          ifelse(Emergency,
                                 5,
                                 ifelse(Elective, 2, 5)))) %>% 
  select(PatientNo, TempMin, TempMax, temp_score, map_score, hr_score, rr_score, a_score, ph_score, na_score, k_score,
         creatinine_score, hematocrit_score, wbc_score, gcs_score, age_score, c_score) %>% 
  mutate_all(replace_na, 0) %>% 
  mutate(apache = temp_score + map_score + hr_score + rr_score + a_score + ph_score + na_score + k_score +
                     creatinine_score + hematocrit_score + wbc_score + gcs_score + age_score + c_score) %>% 
  select(-TempMin, -TempMax)
```

Let's compare with Trinh:

```{r}
apache_trinh <- readRDS("apache.ii_score.rds") %>% 
  mutate_if(is.factor, as.character)

setdiff(apache$PatientNo, apache_trinh$PatientNo)
setdiff(apache_trinh$PatientNo, apache$PatientNo)

marc <- apache %>% 
  arrange(PatientNo) %>% 
  select(-PatientNo, -apache, -a_score, -ph_score)

trinh <- apache_trinh %>% 
  arrange(PatientNo) %>% 
  select(-PatientNo, -aapo2, -pao2, -ph, -hco3, -total_score)

trinh[] <- lapply(trinh, function(x) {x[which(is.infinite(x))] <- 0; x})

#any(! unlist(map2(marc, trinh, identical)))
unlist(map2(marc, trinh, identical))
```

```{r}
data2 %<>% left_join(select(apache_trinh, PatientNo, total_score) %>% rename(apache = total_score), "PatientNo")
```

### Adding mortalities from Trinh

```{r}
data2 <- readRDS("death_day.full.rds") %>% 
  mutate(death28 = Event > 0  & DOD < 29,
         death90 = Event > 0  & DOD < 91) %>% 
  select(PatientNo, death28, death90) %>% 
  left_join(select(readRDS("icu_mortality.full.rds"), -IsTetanus), "PatientNo") %>% 
  rename(deathICU = IsDeath) %>% 
  left_join(data2, ., "PatientNo") %>% 
  mutate(VARI = as.character(VARI) == "VARI")
```

### Filtering the data set

```{r}
data2 %<>% filter(! (IsCompleted > 1 & ! IsAgree),
                  ! PatientNo %in% non_eligible_IDs)
```

### Cleaning the data set

```{r}
data2 %<>% 
  select(PatientNo, hospital, Sex, age, otherhosp, NKQ, tracheostomy, CLBSI_risk,
         ALBSI_risk, apache, charlson_cat, Tetanus, Pneumonia, sepsis, CNS, COPD,
         CVA, Myo, otherpath, dia_co, Mode, rand2icu, rand2hos, adm2icu, adm2hos,
         had_catheter, nb_cl_days, had_arterial, nb_al_days, habsi, habsi_risk,
         CLBSI_risk, CLBSI, ALBSI_risk, ALBSI, death28, death90, deathICU, VARI,
         nb_bsi, nb_path_bsi1) %>% 
  mutate_if(is.numeric, as.integer)
```

### Looking at the dates

`HospitalDate`: date of hospitalization

`ICUDateADM`: date of ICU

`ICUDateFINISH`: date of ICU discharge

`HosDate`: date of hospital discharge

```{r}
data2 %>% 
  select_if(is.Date)
```

```{r}
#data2 %>% 
#  select(PatientNo, OutCome, HospitalDate, ICUDateADM, ICUDateFINISH, HosDate , HosSame)
```

## 2. Derivation of Table 1 on demographics

```{r}
groups <- c("habsi_risk", "habsi", "CLBSI_risk", "CLBSI", "ALBSI_risk", "ALBSI", "Tetanus", "death at ICU discharge", "death at hospital discharge")
```

```{r}
remove_boolean <- function(x) {
  sel <- which(x[, 1] == "- TRUE")
  x[sel - 2, c(3, 5, 7)] <- x[sel, c(3, 5, 7)]
  x[-c(sel - 1, sel), ]
}
```

```{r}
add_cause_admission <- function(x, causes) {
  sel <- which(x[, 1] == causes[1])
  nb <- x[sel, ]
  nb[1] <- "Causes of admission"
  nb[c(3, 5, 7)] <- ""
  x[which(x[, 1] %in% causes), 2] <- ""
  x <- rbind(x[1:(sel - 1), ], nb, x[sel:nrow(x), ])
  for(i in causes) x[, 1] <- sub(i, paste("-", i), x[, 1])
  x
}
```

```{r}
patient_day <- function(g, v, df) {
  df %>% 
    group_by({{ g }}) %>% 
    summarise(pd = sum({{ v }}, na.rm = TRUE)) %>% 
    pivot_wider(names_from = 1, values_from = pd) %>% 
    unlist() %>% 
    rev(.) %>% 
    c(sum(.)) %>% 
    `[<-`(c("patient-day", rep("", 6)), c(2, 4, 6), .)
}
```

```{r}
mean_ci <- function(x) {
  m <- lm(x ~ 1)
  paste0(round(coef(m), 2), " (", paste(round(confint(m), 2), collapse = ", "), ")")
}
mean_ci(data2$nb_cl_days)
```

```{r}
day_per_patient <- function(g, v, data) {
  data %>% 
    group_by({{ g }}) %>% 
    summarise(a = mean_ci({{ v }})) %>%
    pivot_wider(names_from = 1, values_from = a) %>% 
    unlist() %>% 
    rev(.) %>% 
    c(mean_ci(unlist(select(data, {{ v }})))) %>% 
    `[<-`(c("day/patient", rep("", 6)), c(3, 5, 7), .) %>% 
    `[<-`(c(2, 4, 6), group_by(data, {{ g }}) %>%
                        tally() %>%
                        pull() %>%
                        rev() %>% 
                        c(nrow(data)))
}
```

```{r, include = FALSE, eval = FALSE}
ht_theme_markdown <- function(ht, header_rows = 1, header_cols = 1,
                              border_width = .8, border_color = grey(.75),
                              strip = TRUE) {
  top_border(ht)[1, ] <- border_width
  bottom_border(ht)[nrow(ht), ] <- border_width
  for (header_row in header_rows) bold(ht)[header_row, ] <- TRUE
  bottom_border(ht)[max(header_rows), ] <- border_width
  for (header_col in header_cols) bold(ht)[header_col, ] <- TRUE
  ht <- set_all_border_colors(ht, border_color)
  if(strip) ht <- map_background_color(ht, by_rows(grey(.95), "white"))
  ht
}
```

```{r}
data2 %>% 
  mutate(habsi2 = ifelse(habsi, "HABSI", "non-HABSI")) %>%
  assign("data2tmp", ., 1) %>% 
  mutate_at(c("rand2icu", "rand2hos", "adm2icu", "adm2hos"), as.integer) %>% 
  sstable.baseline(hospital + Sex + age + otherhosp + NKQ + tracheostomy +
                   CLBSI_risk + ALBSI_risk + apache + charlson_cat + Tetanus +
                   Pneumonia + sepsis + CNS + COPD + CVA + Myo + otherpath +
                   dia_co + Mode + rand2icu + rand2hos + adm2icu + adm2hos +
                   had_catheter + nb_cl_days + had_arterial + nb_al_days +
                   habsi + deathICU + death28 + death90 ~ habsi2,
                   data = ., pooledGroup = TRUE, digits = 0, flextable = FALSE) %>% 
  `$`("table") %>% 
  as.data.frame(stringsAsFactors = FALSE) %>% 
  remove_boolean() %>% 
  add_cause_admission(c("Tetanus", "Pneumonia", "sepsis", "CNS", "COPD", "CVA", "Myo", "otherpath")) %>% 
  assign("tmp", ., 1) %>% 
  tail(., nrow(.) - 2) %>% 
  mutate(V1 = sub("-", "-   -", V1)) %>% 
  `colnames<-`(tmp[2, ]) %>%
  as.matrix %>% 
  rbind(reduce(list(patient_day(habsi2, rand2icu, data2tmp),
                    patient_day(habsi2, rand2hos, data2tmp),
                    patient_day(habsi2, nb_cl_days, data2tmp),
                    patient_day(habsi2, nb_al_days, data2tmp),
                    day_per_patient(habsi2, nb_cl_days, data2tmp),
                    day_per_patient(habsi2, nb_al_days, data2tmp)), rbind) %>%
          as_tibble() %>% # to be able to use mutate()
          mutate(V1 = c("rand2icu pd", "rand2hos pd", "nb_cl pd", "nb_al pd", "nb_cl pp", "nb_al pp")) %>% 
          as.matrix()) %>% # to be able to use rbind() (because column names do not match)
  as.data.frame(stringsAsFactors = FALSE) #%>% 
#  as_hux(add_rownames = FALSE, add_colnames = TRUE) %>% 
#  insert_row(c(unname(unlist(tmp[1, 2:ncol(tmp)])), "")) %>%
#  add_footnote("- n = number of patients included in that summary statistic.", border = 0) %>%
#  add_footnote("- Values in the form of X(A, B) are medians followed by the 25th and 75th percentiles in parentheses.", border = 0) %>%
#  set_caption("Baseline characteristics of study population.") %>%
#  set_caption_pos("bottom") %>%
#  merge_cells(1, 2:3) %>%
#  merge_cells(1, 4:5) %>%
#  merge_cells(1, 6:7) %>%
#  set_bold(2, everywhere, value = TRUE) %>%
#  set_align(1, 2, "center") %>%
#  set_align(1, 4, "center") %>%
#  set_align(2, everywhere, "center") %>%
#  set_width(1) %>%
#  ht_theme_markdown(header_rows = 1:2)
```

## 3. Derivation of Aetiology of BSI

Number of BSI episodes:

```{r}
list(data2 %>% 
       group_by(nb_bsi) %>% 
       tally(),
     data2 %>%
       filter(habsi) %>% 
       group_by(nb_bsi) %>% 
       tally(),
     data2 %>% 
       filter(CLBSI) %>% 
       group_by(nb_bsi) %>% 
       tally()) %>% 
  reduce(left_join, "nb_bsi") %>% 
  mutate_all(replace_na, 0) %>% 
  setNames(c("nb BSI episodes", "all patients", "with HABSI", "with CLBSI"))
```

Number of pathogens in the first episode of BSI:

```{r}
list(data2 %>% 
       group_by(nb_path_bsi1) %>% 
       tally() %>% 
       drop_na(),
     data2 %>% 
       filter(habsi) %>% 
       group_by(nb_path_bsi1) %>% 
       tally() %>% 
       drop_na(),
     data2 %>% 
       filter(CLBSI) %>% 
       group_by(nb_path_bsi1) %>% 
       tally() %>% 
       drop_na()) %>% 
  reduce(left_join, "nb_path_bsi1") %>% 
  setNames(c("nb pathog in 1st BSI", "all patients", "with HABSI", "with CLBSI"))
```

## 4. Derivation of Frequency of BSI aetiology

### All BSI episodes

Total number of episodes:

```{r}
(nb_episodes <- data$MICBLD %>% 
  filter(episode > 0) %>% 
  group_by(PatientNo, episode) %>% 
  nrow())
```

Frequencies of pathogens for all the BSI episodes:

```{r}
(path_freq <- data$MICBLD %>% 
  filter(episode > 0) %>% 
  group_by(PatientNo, episode) %>% 
  summarise(path = paste(unlist(pathogens), collapse = ", ")) %>% 
  ungroup() %>% 
  pull(path) %>% 
  strsplit(", ") %>%
  unlist() %>% 
  table() %>% 
  sort(TRUE))
```

As proportions:

```{r}
path_freq / nb_episodes
```

### First BSI episodes

Total number of first BSI episodes:

```{r}
(nb_1st_episodes <- data$MICBLD %>% 
  filter(episode < 2) %>% 
  nrow())
```

Frequencies of pathogens for all the first BSI episodes:

```{r}
(path_freq_1step <- data$MICBLD %>% 
  filter(episode < 2) %>% 
  pull(pathogens) %>% 
  strsplit(", ") %>%
  unlist() %>% 
  table() %>% 
  sort(TRUE))
```

As proportions:

```{r}
path_freq_1step / nb_1st_episodes
```

### CLBSI (first) episodes

Reminder: patients are classified CLBSI or ALBSI based on their first BSI
episode. Here we consider only the first episodes of CLBSI patients. First, the
total number of CLBSI patients (and hence CLBSI first episodes):

```{r}
(nb_clbsi <- nrow(clbsi))
```

Frequencies of pathogens for all the first CLBSI episodes:

```{r}
(path_freq_1stCLBSI <- data$MICBLD %>% 
  filter(PatientNo %in% clbsi$PatientNo, episode < 2) %>% 
  pull(pathogens) %>% 
  strsplit(", ") %>%
  unlist() %>% 
  table() %>% 
  sort(TRUE))
```

As proportions:

```{r}
path_freq_1stCLBSI / nb_clbsi
```

### ALBSI (first) episodes

Reminder: patients are classified CLBSI or ALBSI based on their first BSI
episode. Here we consider only the first episodes of CLBSI patients. First, the
total number of ALBSI patients (and hence ALBSI first episodes):

```{r}
(nb_albsi <- nrow(albsi))
```

Frequencies of pathogens for all the first CLBSI episodes:

```{r}
(path_freq_1stALBSI <- data$MICBLD %>% 
  filter(PatientNo %in% albsi$PatientNo, episode < 2) %>% 
  pull(pathogens) %>% 
  strsplit(", ") %>%
  unlist() %>% 
  table() %>% 
  sort(TRUE))
```

As proportions:

```{r}
path_freq_1stALBSI / nb_albsi
```

### non-CLBSI (first) episodes

Total number of non-CLBSI patients:

```{r}
(nb_non_clbsi <- data$MICBLD %>% 
  filter(! PatientNo %in% clbsi$PatientNo, episode < 2) %>% 
  nrow())
```

Frequencies of pathogens for all the non-CLBSI episodes:

```{r}
(path_freq_nonCLBSI <- data$MICBLD %>% 
  filter(! PatientNo %in% clbsi$PatientNo, episode < 2) %>% 
  pull(pathogens) %>% 
  strsplit(", ") %>%
  unlist() %>% 
  table() %>% 
  sort(TRUE))
```

As proportions:

```{r}
path_freq_nonCLBSI / nb_non_clbsi
```

## 5. Derivation of BSI incidence rate

```{r}
extract_prop_test <- function(x) {
  unname(unlist(x[c("estimate", "conf.int")]))
}
```



```{r}
put_in_shape <- function(x) {
  paste0(x[1], " (", x[2], ", ", x[3], ")")
}
```



```{r}
calc_prop <- function(x, factor, digits) {
  x %>%
    as.list() %>% 
    reduce(prop.test) %>% 
    extract_prop_test() %>% 
    multiply_by(factor) %>% 
    round(digits) %>% 
    put_in_shape()
}
```


### HABSI rate

```{r}
habsi_rate <- function(x, factor = 1000, digits = 3) {
  x %>% 
    select(habsi, rand2icu) %>% 
    drop_na() %>% 
    summarise_all(sum) %>% 
    unlist() %>% 
    calc_prop(factor, digits)
}
```

Let's try it:

```{r}
habsi_rate(data2)
```

### Proportion of patients with HABSI

```{r}
habsi_prop <- function(x, factor = 100, digits = 3) {
  x %>% 
    select(habsi) %>% 
    drop_na() %>% 
    group_by(habsi) %>% # habsi is boolean
    tally() %>% 
    pull(n) %>% 
    rev() %>% 
    calc_prop(factor, digits)
}
```

Let's try it:

```{r}
habsi_prop(data2)
```

### Number of central line days

```{r}
nb_cl_days_fct <- function(x) {
  sum(x$nb_cl_days, na.rm = TRUE) %>% 
    as.numeric() %>% 
    as.character()
}
```

Let's try it:

```{r}
nb_cl_days_fct(data2)
```

### Central line utilization ratio

```{r}
cl_utilization_ratio <- function(x, factor = 1000, digits = 3) {
  x %>% 
    select(nb_cl_days, rand2icu) %>% 
    drop_na() %>% 
    summarise_all(sum) %>% 
    unlist() %>% 
    calc_prop(factor, digits)
}
```

Let's try it:

```{r}
cl_utilization_ratio(data2)
```

### CLBSI rate

```{r}
clbsi_rate <- function(x, factor = 1000, digits = 3) {
  x %>% 
    select(CLBSI, nb_cl_days) %>% 
    drop_na() %>% 
    summarise_all(sum) %>% 
    unlist() %>% 
    calc_prop(factor, digits)
}
```

Let's try it:

```{r}
clbsi_rate(data2)
```

#### Putting together

```{r}
make1row <- function(x) {
    map(list(habsi_rate, habsi_prop, nb_cl_days_fct, cl_utilization_ratio, clbsi_rate),
        function(f) f(x)) %>%
    as.data.frame(stringsAsFactors = FALSE) %>% 
    unname()
}
```

Let's try it:

```{r}
make1row(data2)
```

```{r}
make1group <- function(x) {
  data2 %>% 
    filter(! is.na(.[[x]])) %>% 
    group_by(.[[x]]) %>% 
    group_modify(~ make1row(.x)) %>% 
    ungroup()
}
```

Let's try it:

```{r}
make1group("hospital")
```

let's consider the following groups:

```{r}
groups <- c("hospital", "Tetanus", "ALBSI", "tracheostomy", "deathICU", "death28", "death90")
```

This will be the names of the columns in the final data frame:

```{r}
col_names <- c("group", "HABSI rate", "proportion of HABSI", "# CL days", "CL utilization ratio", "CLBSI rate")
```

Let's compute the statistics for all the groups:

```{r}
out <- map(groups, make1group) %>% 
  c(list(as.data.frame(c("all", make1row(data2)), stringsAsFactors = FALSE)), .) %>% 
  lapply(setNames, col_names) %>% 
  lapply(mutate_at, 1, as.character)
```

The intermediate titles:

```{r}
inter <- lapply(groups, function(x) {
                          x %>%
                            c(rep("", 5)) %>% 
                            t() %>% 
                            as.data.frame(stringsAsFactors = FALSE) %>% 
                            setNames(col_names)
                        })
```

let's put everything together:

```{r}
lapply(1:7, function(x) c(out[x], inter[x])) %>%
  unlist(FALSE) %>% 
  c(out[8]) %>% 
  bind_rows()
```

## 6. Risk factors associated with BSI

## 7. Risk factors associated with mortality

## 8. Kaplan–Meier analysis